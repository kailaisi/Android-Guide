## 代码重构法则

译文：https://sourcemaking.com/refactoring/smells/long-method

#### 长方法

**特征**

一个方法包含了很多行代码。一般情况下，任何超过10行的方法都应该反思一下是不是有问题。

**问题的原因**

一个方法中的代码总是在不断的增加，很少去删除。由于编写代码比阅读代码更容易，所以这种情况一直没有被注意到，直到这个方法变得臃肿而又丑陋。

从精神上讲，在已有的方法中增加代码要比创建一个新方法更加简单："仅仅是两行代码，没必要为了它去创建一个新方法"。然后添加了一行，有添加了一行，然后整个方法变成了又臭又长的裹脚布。

**解决方案**

就像经验之谈，如果你觉得一个方法内的一些代码块需要使用注释了，那么就可以尝试将这部分代码块提取成一个新的方法。即使是一行代码，如果需要解释的话，也应该拆分出一个单独的方法。而如果我们的方法命名比较有描述性，就无需查看代码就能知道这个方法的功能。

![img](https://sourcemaking.com/images/refactoring-illustrations/2x/long-method-2.png)

* 如果需要减少方法的长度，使用**提取法**
* 如果本地变量或者参数影响方法的提取，使用**用查询替换temp法**、**引入参数对象法**、**保存整个对象法**
* 如果上面的方法无效，尝试通过**用方法对象替换方法**这种方式将整个方法移到一个单独的类中。
* 条件运算符和循环是一种很好的线索，可以将代码块抽取到单独的方法中。对于条件运算符采用**条件分解法**，而对于循环则可以使用**提取法**

**代价**

* 在所有面向对象编程中，短方法的存活时间更长。方法越长就越理解和维护。
* 长方法是为不必要的重复代码提供了完美的隐藏位置。

![img](https://sourcemaking.com/images/refactoring-illustrations/2x/long-method-3.png)

**性能**

就像很多人所担忧的那样，方法的增加会影响性能么？几乎在所有的情况下，这种影响都是可以忽略不计的，甚至不值得担心。

另外，你已经有了清晰易懂的代码，如果需要的话，你完全可以找到更有效的方法来重构代码来获取真正意义上的性能提升。



#### 大类

**特征**

一个类中包含了很多的字段/方法/代码行

![img](https://sourcemaking.com/images/refactoring-illustrations/2x/large-class-1.png)

**问题的原因**

一个类刚创建的时候基本上简短。但是随着时间的推移，它会随着程序的增长而膨胀。

像长方法一样，程序员通常感觉在现有的类中添加一个新特性要比为这段代码创建一个新类更加省事。

**解决方案**

当一个类包含了太多功能的时候，尝试去拆分它：

![img](https://sourcemaking.com/images/refactoring-illustrations/2x/large-class-2.png)

* 如果大类的一部分行为可以拆分为单独的组件，可以参考**提取类法**
* 如果大类的的部分行为可以以不同的方式实现，或者很少使用的话，可以使用**提取子类法**
* 如果可以列出客户端可以使用的操作或者行为列表，可以使用**提取接口法**
* 如果大型类负责图形界面，则可以尝试将其某些数据和行为移动到单独的域对象。在这样做时，可能需要将某些数据的副本存储在两个地方，并保持数据的一致性。[重复观测数据](https://sourcemaking.com/refactoring/duplicate-observed-data)提供了一种方法来做这件事。

**结果**

* 这些类的重构，使开发者不必记住大量的类属性
* 大多数情况下，大类的分割能够有效的避免代码和功能的重复

![img](https://sourcemaking.com/images/refactoring-illustrations/2x/large-class-3.png)

#### 痴迷于原始数据

**特征**

* 对于一些简单的任务，使用原始数据而不是简单的对象(比如货币、范围、手机号字符串等等)
* 使用常量来表示信息(例如用静态 `USER_ADMIN_ROLE = 1` 来表示用户的管理员权限)
* 使用字符串常量作为字段名

![img](https://sourcemaking.com/images/refactoring-illustrations/2x/primitive-obsession-1.png)

**问题原因**





#### 长参数

**特征**

一个方法有三个或者四个以上的参数。

![img](https://sourcemaking.com/images/refactoring-illustrations/2x/long-parameter-list-1.png)

**问题原因**

一个方法中如何融合了几种类型的算法的话，可能就会出现一长串的参数列表。一长串的参数主要用来控制执行那种算法。

长参数列表也许是使类更加独立的副产品。例如。某个方法中用于创建特殊对象的代码，从当前的方法中移到了调用该方法的内部。这样的话，创建的对象就需要作为一个参数传递给该方法。这样的话，原始类就不需要关心对象之间的关系，依赖关系减少了。如果创建多个对象的话，那么就会形成一种长参数。

长参数是特别难以理解的，随着时间的增长，这些参数就变得难以使用。方法可以使用自己的对象数据，而不是一长串的参数。如果当前对象没有包含必须的数据，那么可以创建一个对象(它将获取必须的数据)作为方法的参数传递

**方法**

* 仔细检测参数，如果参数只是另一个对象的方法的调用结果。请使用**用方法调用代替参数法**。这个对象可以作为自己的类的字段，也可以作为方法参数传递。![img](https://sourcemaking.com/images/refactoring-illustrations/2x/long-parameter-list-2.png)
* 与其将从另一个对象接收的一组数据作为参数传递，不如通过**保存整个对象法**将对象本身传递给方法。
* 如果有几个无关的参数，可以通过**引入参数对象法**来处理。

**效果**

* 更易读、更简短
* 重构可以暴漏出未注意到的重复代码。

**什么时候忽视这种优化**

如果这样做会导致类之间不必要的依赖关系，请不要移除参数。

#### 数据群

**特征**

不同的代码块中包含了相同的变量组信息(例如数据库连接的参数)。这些组信息应该拥有自己单独的类。

##### 重构技巧(todo)