## ç”µé‡ä¼˜åŒ–ä½ ä¸å¾—ä¸çŸ¥é“çš„ç§˜å¯†

ä»€ä¹ˆï¼Ÿæˆ‘å†™ä¸ªâ€œç ´â€åº”ç”¨è¿˜å¾—ç®¡ç”µé‡ï¼Ÿæˆ‘å“ªå„¿çŸ¥é“è‡ªå·±å†™çš„åº”ç”¨è´¹ä¸è´¹ç”µå•Šã€‚ã€‚ã€‚

ä½†æ˜¯å½“æˆ‘ä»¬è‡ªå·±ä½¿ç”¨æ‰‹æœºçš„æ—¶å€™ï¼šè¿™ä¸ªç ´åº”ç”¨æ€ä¹ˆé‚£ä¹ˆè´¹ç”µï¼Ÿé•¿æŒ‰ï¼Œä¸Šæ»‘ï¼Œèµ°èµ·~~~

çœ‹åˆ°æ²¡ï¼Œç”µé‡ä¼˜åŒ–ä½ èƒ½ä¸é‡è§†ä¹ˆï¼Ÿå¥½å§ï¼Œæˆ‘ä»¬çš„åº”ç”¨ä½“é‡å°ï¼Œè¿˜çœŸæ²¡æ€ä¹ˆä¼˜åŒ–è¿‡ğŸ˜„ã€‚å…¶å®è¯´èµ·â€œç”µé‡ä¼˜åŒ–â€è¿™ä¸ªè¯ï¼Œæ€»æœ‰ä¸€ç§ç¥ç§˜æ„Ÿï¼Œä¸çŸ¥ä»ä½•å…¥æ‰‹ã€‚é‚£ä¹ˆè¿™é‡Œä¼šå‘Šè¯‰ä½ ï¼Œä»€ä¹ˆæ˜¯ç”µé‡ä¼˜åŒ–ï¼Œä¼˜åŒ–åˆæ˜¯ä¼˜åŒ–ä»€ä¹ˆï¼Œæ€ä¹ˆå»åšä¼˜åŒ–~

### åŸºç¡€çŸ¥è¯†

![Androidç”µé‡ä¼˜åŒ–](http://cdn.qiniu.kailaisii.com/typora/20200626175810-750951.png)

#### æ¦‚è¿°

å…¶å®å¯¹äºä¸€ä¸ªç§»åŠ¨è®¾å¤‡æ¥è¯´ï¼Œæœ‰ä¸¤ä¸ªè€—ç”µå¤§æˆ·ï¼šCPUå’Œæ˜¾ç¤ºå±ã€‚ä¸ºäº†é™ä½è¿™ä¸¤ä¸ªå…ƒä»¶çš„è€—ç”µé‡ï¼Œåœ¨Androidç³»ç»Ÿä¸­ï¼Œä¹Ÿä¼šé€šè¿‡ç”µæºç®¡ç†æ¥å®ç°é™ä½ç”µé‡æ¶ˆè€—çš„åŠŸèƒ½ã€‚

å¯¹äºCPUï¼Œå¤§å¤šéƒ½ä¼šè®¾è®¡ä¸¤ç§å·¥ä½œé¢‘ç‡ï¼Œå¤§éƒ¨åˆ†æ—¶é—´å†…CPUéƒ½å·¥ä½œåœ¨**é™ä½é¢‘ç‡**ä¸‹ï¼Œåªæœ‰**è¿›è¡Œå¯†é›†è®¡ç®—**æ—¶ï¼Œæ‰ä¼šåˆ‡æ¢åˆ°é«˜é¢‘ç‡ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬çœ‹è§†é¢‘ï¼Œçœ‹ç›´æ’­ï¼Œç©æ¸¸æˆï¼Œä¸Šç½‘çš„æ—¶å€™ï¼Œä¼šæ˜æ˜¾æ„Ÿè§‰æ‰‹æœºç©ä¸äº†å¤šä¹…å°±å¾—å……ç”µçš„åŸå› ã€‚

å¯¹äºæ˜¾ç¤ºå±ã€‚ç³»ç»Ÿåˆ™ä¼šå°½é‡å‡å°‘äº®å±çš„æ—¶é—´ï¼Œå½“ç”¨æˆ·é•¿æ—¶é—´ä¸æ“ä½œçš„æ—¶å€™ï¼Œå°±ä¼šæ¯å±ç­‰ç­‰ã€‚

#### ç”µæºç®¡ç†æ¶æ„

Androidç³»ç»Ÿæœ‰ä¸€å¥—è‡ªå·±çš„æ¶æ„æ¥æ¥å®ç°æ¥å®ç°å¯¹äºç”µæºçš„ç®¡ç†ã€‚å…¶ä¸»è¦åˆ†ä¸ºå››ä¸ªå±‚æ¬¡ï¼š

**åº”ç”¨æ¥å£å±‚**ï¼šPowerMangerå¼€æ”¾ç»™åº”ç”¨ä¸€ç³»åˆ—çš„æ¥å£ï¼Œåº”ç”¨å¯ä»¥é€šè¿‡PMçš„æ¥å£æ¥ç”³è¯·wakelockï¼Œå”¤é†’ç³»ç»Ÿï¼Œä½¿ç³»ç»Ÿè¿›å…¥ç¡çœ ç­‰æ“ä½œã€‚

**Frameworkå±‚**ï¼šåº”ç”¨è°ƒç”¨PowerManagerå¼€æ”¾çš„æ¥å£ï¼Œæ¥å¯¹ç³»ç»Ÿè¿›è¡Œä¸€äº›åˆ—çš„æ“ä½œæ˜¯åœ¨PowerManagerServiceä¸­å®Œæˆçš„ã€‚PMSä¸­å¤„ç†å’Œç”µé‡ç›¸å…³çš„è®¡ç®—ã€‚å±äºç”µæºç®¡ç†çš„å†³ç­–å±‚ã€‚åè°ƒä¸å…¶ä»–æ¨¡å—çš„äº¤äº’ï¼Œæ¯”å¦‚äº®å±ã€æš—å±ã€ç³»ç»Ÿä¼‘çœ ã€å”¤é†’ç­‰ç­‰ã€‚

**HALå±‚**ï¼špower.cæ–‡ä»¶ï¼Œé€šè¿‡ä¸Šå±‚ä¼ é€’ä¸‹æ¥çš„å‚æ•°ï¼Œå‘/sys/power/wake_lockæˆ–è€…/sys/power/wake_unlockæ–‡ä»¶èŠ‚ç‚¹å†™æ•°æ®ä¸Kernelå±‚è¿›è¡Œé€šä¿¡ã€‚

**Kernelå±‚**ï¼šæ§åˆ¶å¯¹åº”çš„ç¡¬ä»¶ã€‚ä¸ç®¡æ˜¯å±å¹•è¿˜æ˜¯cpuï¼Œç»Ÿå±äºç¡¬ä»¶ï¼Œæœ€ç»ˆé€šè¿‡å¯¹ç¡¬ä»¶çš„æ§åˆ¶æ¥å®ç°å¯¹ç”µé‡ç®¡ç†ã€‚

æ•´ä¸ªæ¶æ„å¦‚ä¸‹ï¼š

![img](http://cdn.qiniu.kailaisii.com/typora/20200626180043-902698.png)

**é‡è¦çš„æ¥å£**

åœ¨ç”µæºç®¡ç†ç³»ç»Ÿä¸­ï¼Œä»‹ç»å‡ ä¸ªæ¯”è¾ƒçš„æ¥å£ã€‚

* userActivity()ï¼šæŠ¥å‘Šå½±å“ç³»ç»Ÿä¼‘çœ çš„ç”¨æˆ·æ´»åŠ¨ï¼Œé‡æ–°è®¡ç®—ç­å±æ—¶é—´ã€‚å‡è®¾æˆ‘ä»¬æ‰‹æœºè®¾ç½®15ç§’ä¸æ“ä½œï¼Œå°±æ¯å±ã€‚é‚£ä¹ˆæˆ‘ä»¬æ¯æ¬¡è§¦å±æˆ–è€…æ»‘å±çš„æ—¶å€™ï¼Œéƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œç„¶åç³»ç»Ÿä¼šé‡æ–°è¿›è¡Œå€’è®¡æ—¶çš„æ“ä½œã€‚
* Wakelockï¼šæä¾›äº†ç›¸å…³çš„æ¥å£æ¥æ“ä½œwakelocké”ã€‚æ¯”å¦‚è¯´ç”³è¯·æˆ–è€…é‡Šæ”¾ç­‰ã€‚

#### WakeLockæœºåˆ¶

wakelockæ˜¯ä¸€ç§é”æœºåˆ¶ï¼Œåªè¦æœ‰åº”ç”¨æ‹¿ç€è¿™ä¸ªé”ï¼Œé‚£ä¹ˆCPUå°±æ— æ³•è¿›å…¥ä¼‘çœ ï¼Œä¼šä¸€ç›´å¤„äºå·¥ä½œçš„çŠ¶æ€ã€‚

ä¸€èˆ¬æ‰‹æœºå¾…æœºæ—¶ï¼ŒLCDã€WIFIéƒ½ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼ŒAndroidåº”ç”¨ç¨‹åºçš„ä»£ç ä¹Ÿä¼šåœæ­¢è¿è¡Œã€‚

ä¸ºäº†**ä¿è¯ç¨‹åºä¸­å…³é”®ä»£ç çš„æ­£ç¡®æ‰§è¡Œï¼Œæä¾›äº†Wake Lockçš„API**ï¼Œä½¿å¾—åº”ç”¨ç¨‹åºèƒ½å¤Ÿé€šè¿‡ä»£ç é˜»æ­¢CPUè¿›å…¥ä¼‘çœ çŠ¶æ€ã€‚è€Œè¿™ç§æƒ…å†µçš„æ»¥ç”¨ï¼Œåˆ™ä¼šæˆä¸ºç”µé‡æ€æ‰‹ã€‚

#### JobScheduler

JobScheduleræ˜¯å®‰å“5.0æ¨å‡ºçš„APIï¼Œå…è®¸å¼€å‘è€…åœ¨**ç¬¦åˆæŸäº›æ¡ä»¶æ—¶åˆ›å»ºæ‰§è¡Œåœ¨åå°çš„ä»»åŠ¡**ã€‚

JobSchedulerçš„ç›®çš„æ˜¯ä¸ºäº†æŠŠä¸€äº›ä¸æ˜¯ç‰¹åˆ«ç´§æ€¥çš„ä»»åŠ¡æ”¾åˆ°æ›´åˆé€‚çš„æ—¶æœºå»æ‰¹é‡å¤„ç†æ•°æ®ã€‚è¿™ä¹ˆåšæœ‰ä¸¤ä¸ªå¥½å¤„ï¼š

* é¿å…é¢‘ç¹çš„å”¤é†’ç¡¬ä»¶æ¨¡å—ï¼Œé€ æˆä¸å¿…è¦çš„ç”µé‡æ¶ˆè€—
* é¿å…åœ¨ä¸åˆé€‚çš„æƒ…å†µä¸‹ï¼ˆå¦‚ä½ç”µé‡ã€å¼±ç½‘ç»œæˆ–ç§»åŠ¨ç½‘ç»œï¼‰ä¸‹æ‰§è¡Œè¿‡å¤šçš„ä»»åŠ¡æ¶ˆè€—ç”µé‡ã€‚

#### è€—ç”µç»Ÿè®¡

è€—ç”µç»Ÿè®¡æ˜¯ä¸€ä¸ªç³»ç»Ÿçš„ç»„ä»¶ï¼Œä¼´éšç€ç³»ç»Ÿè¿è¡Œçš„æ•´ä¸ªè¿‡ç¨‹ã€‚è¿™ä¸ªç»Ÿè®¡æ˜¯åŸºäºè½¯ä»¶å±‚é¢å®ç°çš„ï¼Œæ‰€ä»¥ä¸åŒè€Œç¡¬ä»¶æ¨¡å—é…ç½®ä¸åŒçš„å‚æ•°ï¼Œç„¶åä½¿ç”¨ç®—æ³•è¿›è¡Œä¼°ç®—ï¼Œè°·æ­Œè¦æ±‚OEMå‚å•†å¿…é¡»æµ‹é‡å¹¶æä¾›å…¶å®é™…å€¼å¹¶å†™å…¥åˆ°power_profileæ–‡ä»¶ã€‚

### å·¥å…·

å¨å¨é‚£ä¹ˆå¤šï¼Œé‚£ä¹ˆæˆ‘æ€ä¹ˆçŸ¥é“æˆ‘çš„åº”ç”¨è€—ç”µå¤šå°‘å•Šï¼Ÿå…¶å®è¿˜æ˜¯æœ‰ä¸€äº›åŠŸèƒ½èƒ½å¤Ÿè¾…åŠ©æˆ‘ä»¬æ¥æŸ¥è¯¢ç”µé‡çš„ä½¿ç”¨æƒ…å†µçš„ã€‚

#### Battery Historian

##### ä»‹ç»

Googleæä¾›çš„ä¸€å¥—ä¸“é—¨åˆ†æç”µé‡ä½¿ç”¨çš„å·¥å…·ã€‚èƒ½å¤Ÿ**æ”¯æŒAndroid5.0åŠä»¥å**çš„è®¾å¤‡ä¸Šè¿›è¡Œç”µæ± çš„ç›¸å…³ä¿¡æ¯å’Œäº‹ä»¶åˆ†æã€‚å®ƒæ˜¯ä¸€æ¬¾å¯è§†åŒ–åŠŸèƒ½ï¼Œå¯¹äº**ç³»ç»Ÿçº§åˆ«å’Œåº”ç”¨çº§åˆ«**çš„äº‹ä»¶éƒ½èƒ½å¤Ÿ**æ¸…æ™°ç›´è§‚**çš„å±•ç°å‡ºåº”ç”¨çš„**è€—ç”µæ¯”ä¾‹ã€æ‰§è¡Œæ—¶é—´ã€æ¬¡æ•°**ç­‰ç­‰ã€‚è€Œä¸” è¿˜æ”¯æŒ**ä¸¤ä¸ªbugreportæ–‡ä»¶çš„å¯¹æ¯”**ï¼Œå¯¹å…³é”®çš„åŒºåˆ«ç‚¹é«˜äº®æ˜¾ç¤ºã€‚

##### ä½¿ç”¨æ–¹å¼

é¦–å…ˆæˆ‘ä»¬çœ‹ä¸€ä¸ªå¸¸ç”¨çš„cmdå‘½ä»¤è¡ŒæŒ‡ä»¤ï¼š 

* é‡ç½®ç”µé‡ä¿¡æ¯ï¼šadb shell dumpsys batterystats --reset

* å¼€å¯è®°å½•å…¨é¢çš„ç”µé‡ä¿¡æ¯ï¼šadb shell dumpsys batterystats --enable full-wake-history

* å¯¼å‡ºï¼šadb bugreport bugreport.zip

åœ¨æˆ‘ä»¬è¿›è¡Œå…·ä½“çš„åº”ç”¨çš„ç”µé‡åˆ†æçš„æ—¶å€™ï¼Œæœ€å¥½æ˜¯å…ˆå°†ç”µé‡ä¿¡æ¯é‡ç½®ã€‚ç„¶åæ“ä½œæˆ‘ä»¬çš„åº”ç”¨ï¼Œæ“ä½œä¸€æ®µæ—¶é—´ä»¥åå¯¼å‡ºbugreport.zipï¼ˆç»Ÿè®¡æŠ¥å‘Šï¼‰æ–‡ä»¶ã€‚

**æ³¨æ„äº‹é¡¹ï¼šè·å–ç»Ÿè®¡æŠ¥å‘Šçš„æ—¶å€™ï¼Œéœ€è¦å°†ç»Ÿè®¡é‡ç½®ï¼Œå¹¶æ–­å¼€USBè¿æ¥ï¼Œå¦åˆ™å°†ä¼šå½±å“æœ‰æ•ˆæ€§**

å½“å¯¼å‡ºzipæ–‡ä»¶ä»¥åï¼Œæ‰“å¼€[https://bathist.ef.lc/](https://bathist.ef.lc/)ï¼ˆå¦‚æœè¿™ä¸ªç½‘å€ä¸è¡Œçš„è¯ï¼Œå¯èƒ½éœ€è¦è‡ªå·±æ­å»ºå¯¹åº”çš„ç¯å¢ƒäº†ï¼Œç›¸å…³æ­å»ºæ–‡ç« å¤§å®¶å¯ä»¥è‡ªå·±æŸ¥ä¸€ä¸‹ï¼‰ã€‚ç„¶åä¸Šä¼ zipæ–‡ä»¶ã€‚

![image-20200626171004724](http://cdn.qiniu.kailaisii.com/typora/20200626171005-840917.png)

ä¸Šä¼ å®Œæ–‡ä»¶ä»¥åï¼Œè¿‡ä¸€æ®µæ—¶é—´å°±èƒ½çœ‹åˆ°ç”µæ± çš„ä½¿ç”¨æŠ¥å‘Šã€‚

![image-20200628151349783](http://cdn.qiniu.kailaisii.com/typora/202006/28/151350-248270.png)

##### ç»“æœåˆ†æ

ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œå¯ä»¥çœ‹åˆ°ç”µé‡æœ‰3ä¸ªåœ°æ–¹ä¸‹é™æ¯”è¾ƒå¿«ã€‚

![img](http://cdn.qiniu.kailaisii.com/typora/202006/28/151529-877598.png)

**ä¸‹é™ç‚¹1**

![img](http://cdn.qiniu.kailaisii.com/typora/202006/28/151722-687001.png)

å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ—¶å€™ï¼ŒScreenä¸€è¡Œçš„æ•°æ®éƒ½æ˜¯çº¢è‰²ï¼Œè¡¨æ˜å±å¹•å¤„äºç‚¹äº®çš„çŠ¶æ€ã€‚è€Œä¸‹é¢çš„Top Appä¹Ÿå¤„äºè“è‰²éƒ¨åˆ†ï¼Œè¡¨æ˜æœ‰APPæ­£åœ¨è¿è¡Œï¼Œæ‰€ä»¥è¿™æ—¶å€™å¯ä»¥çœ‹ä¸€ä¸‹å…·ä½“è¿è¡Œçš„APPæ˜¯å“ªä¸ª

![img](https://upload-images.jianshu.io/upload_images/5851256-443002f5c2a97e32.png?imageMogr2/auto-orient/strip|imageView2/2/format/webp)

**ä¸‹é™ç‚¹2**

åœ¨ä¸‹é™ç‚¹2ä¸­ï¼Œç³»ç»Ÿç”±åŸæ¥çš„Dozeç¡çœ æ¨¡å¼å”¤é†’äº†ï¼Œå±å¹•ç‚¹äº®ï¼Œè€ŒwifiçŠ¶æ€ç”±æ‰“å¼€å˜ä¸ºå…³é—­ã€‚å¯ä»¥æ¨æµ‹æ­¤æ—¶ç”¨æˆ·çš„è¡Œä¸ºæ˜¯**ç‚¹äº®å±å¹•ï¼Œå…³é—­WiFi**

![img](http://cdn.qiniu.kailaisii.com/typora/202006/28/153739-879119.png)

**ä¸‹é™ç‚¹3**

åœ¨ä¸‹é™ç‚¹3çœ‹åˆ°å”¤é†’é”é¢œè‰²å¼‚å¸¸ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæœ‰ä¸€ä¸ªåº”ç”¨é•¿æ—¶é—´å ç”¨äº†wakelocké”å¯¼è‡´çš„ã€‚

![img](http://cdn.qiniu.kailaisii.com/typora/202006/28/161808-661898.png)

#### Energy Profiler

##### ä»‹ç»

åœ¨æ­è½½ **Android 8.0 (API 26) æˆ–æ›´é«˜ç‰ˆæœ¬**çš„å…³è”è®¾å¤‡æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡**Profiler**ä¸­çš„**Energy Profiler**æ¥è¿›è¡Œç”µé‡åˆ†æã€‚Energy Profilerèƒ½å¤Ÿ**ç›‘æ§CPUã€ç½‘ç»œæ— çº¿è£…ç½®å’ŒGPSä¼ æ„Ÿå™¨çš„ä½¿ç”¨æƒ…å†µ**ï¼Œå¹¶**ç›´è§‚**åœ°æ˜¾ç¤ºæ¯ä¸ªç»„ä»¶æ¶ˆè€—çš„ç”µé‡ã€‚è€Œä¸”è¿˜èƒ½æ˜¾ç¤ºå¯èƒ½ä¼šå½±å“è€—ç”µé‡çš„ç³»ç»Ÿäº‹ä»¶ï¼ˆå”¤é†’é”å®šã€é—¹é’Ÿã€ä½œä¸šå’Œä½ç½®ä¿¡æ¯è¯·æ±‚ï¼‰çš„å‘ç”Ÿæ¬¡æ•°ã€‚

Energy Profilerå¹¶ä¸ä¼šç›´æ¥æµ‹é‡è€—ç”µé‡ï¼Œè€Œæ˜¯ä½¿ç”¨ä¸€ç§æ¨¡å‹æ¥ä¼°ç®—è®¾å¤‡ä¸Šæ¯é¡¹èµ„æºçš„è€—ç”µé‡ã€‚

##### ä½¿ç”¨æ–¹å¼

1. ä¾æ¬¡é€‰æ‹© **View > Tool Windows > Profiler** æˆ–ç‚¹å‡»å·¥å…·æ ä¸­çš„ **Profile** å›¾æ ‡ ![img](https://developer.android.google.cn/studio/images/buttons/toolbar-android-profiler.png)ã€‚

   å¦‚æœ **Select Deployment Target** å¯¹è¯æ¡†æ˜¾ç¤ºæç¤ºï¼Œè¯·é€‰æ‹©è¦å°†æ‚¨çš„åº”ç”¨éƒ¨ç½²åˆ°å“ªä¸ªè®¾å¤‡ä¸Šä»¥è¿›è¡Œåˆ†æã€‚å¦‚æœæ‚¨å·²é€šè¿‡ USB è¿æ¥è®¾å¤‡ä½†ç³»ç»Ÿæœªåˆ—å‡ºè¯¥è®¾å¤‡ï¼Œè¯·ç¡®ä¿æ‚¨å·²[å¯ç”¨ USB è°ƒè¯•](https://developer.android.google.cn/studio/debug/dev-options#enable)ã€‚

2. ç‚¹å‡» **Energy** æ—¶é—´è½´ä¸­çš„ä»»æ„ä½ç½®ä»¥æ‰“å¼€ Energy Profilerã€‚

ç„¶åå°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„å›¾ç‰‡

![img](http://cdn.qiniu.kailaisii.com/typora/202006/24/161856-5340.png)

å¦‚å›¾æ‰€ç¤ºï¼ŒEnergy Profiler çš„é»˜è®¤è§†å›¾åŒ…æ‹¬ä»¥ä¸‹æ—¶é—´è½´ï¼š

1. **â€œEventâ€æ—¶é—´è½´**ï¼šæ˜¾ç¤ºåº”ç”¨ä¸­çš„ Activity åœ¨å…¶ç”Ÿå‘½å‘¨æœŸå†…ä¸æ–­è½¬æ¢è€Œç»å†å„ç§ä¸åŒçŠ¶æ€çš„è¿‡ç¨‹ã€‚æ­¤æ—¶é—´è½´è¿˜ä¼šæŒ‡ç¤ºç”¨æˆ·ä¸è®¾å¤‡çš„äº¤äº’ï¼ŒåŒ…æ‹¬å±å¹•æ—‹è½¬äº‹ä»¶ã€‚
2. **â€œEnergyâ€æ—¶é—´è½´**ï¼šæ˜¾ç¤ºåº”ç”¨çš„ä¼°ç®—è€—ç”µé‡ã€‚
3. **â€œSystemâ€æ—¶é—´è½´**ï¼šæ˜¾ç¤ºå¯èƒ½ä¼šå½±å“è€—ç”µé‡çš„ç³»ç»Ÿäº‹ä»¶ã€‚

![image-20200624154458348](http://cdn.qiniu.kailaisii.com/typora/202006/24/154459-592577.png)

å½“æˆ‘ä»¬å‘ç°æŸä¸€ä¸ªæ—¶åˆ»çš„è€—ç”µé‡æ¯”è¾ƒé«˜çš„æ—¶å€™ï¼Œå°†é¼ æ ‡æŒ‡é’ˆæ”¾åœ¨**Energy**æ—¶é—´è½´ä¸­çš„æ¡å½¢ä¸Šï¼Œå°±å¯ä»¥æ˜¾ç¤ºå‡ºå¦‚ä¸Šå›¾çš„è¯´æ˜ã€‚è¿™é‡Œä¼šæ˜¾ç¤ºå‡ºCPUã€ç½‘ç»œå’ŒGPSçš„ä½¿ç”¨æƒ…å†µã€‚è€Œä¸‹é¢åˆ™ä¼šä¼šæ˜¾ç¤º**Wake Locks**å’Œå¯¹åº”çš„**Jobs**ä¿¡æ¯ã€‚

##### å®æˆ˜åˆ†æ

è¿™é‡Œæˆ‘ä»¬ç”³è¯·äº†ä¸€ä¸ªwakeLockä»£ç ï¼Œç‰‡æ®µå¦‚ä¸‹ï¼š

```java
        PowerManager powerManager = (PowerManager) getSystemService(Context.POWER_SERVICE);
        PowerManager.WakeLock lock = powerManager.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK, "test");
        lock.acquire(16 * 1000);
```

![GIF 2020-6-26 18-18-14](http://cdn.qiniu.kailaisii.com/typora/20200626182203-427902.gif)

1. ä¸Šé¢çš„åŒºåŸŸå¯ä»¥å®æ—¶çš„æ˜¾ç¤ºæˆ‘ä»¬å½“å‰åº”ç”¨çš„ç½‘ç»œè¯·æ±‚ã€ä½ç½®ã€CPUçš„çŠ¶æ€ç­‰
2. åº•éƒ¨çš„çº¢è‰²è¡¨ç¤ºæœ‰wake lockã€‚å½“æˆ‘ä»¬é€‰ä¸­è¿™éƒ¨åˆ†åŒºåŸŸä»¥åï¼Œå°±å¯ä»¥åœ¨å³ä¾§çœ‹åˆ°ç”³è¯·wakelockçš„ä»£ç ä½ç½®ã€‚

è¿™ç§æ–¹å¼æ›´åŠ ç›´è§‚ç®€å•ã€‚ä¸å†éœ€è¦æˆ‘ä»¬å»å¯¼å‡ºæ–‡ä»¶ç„¶åä¸Šä¼ åˆ†æäº†ï¼Œæ‰€ä»¥ä½¿ç”¨ä¸Šæ¥è¯´æ›´ç®€å•ä¸€äº›ã€‚

ä½†æ˜¯ç›¸å¯¹äºBattery Historianèƒ½å¤Ÿé•¿æ—¶é—´è®°å½•ä½¿ç”¨æƒ…å†µå¹¶ä¸”èƒ½å¤Ÿåˆ†æå¤„ç†ï¼Œè¿™ç§éœ€è¦å®æ—¶çš„å»ç›¯ç€é¡µé¢çš„ï¼Œå¯èƒ½å°±æœ‰äº›ä¸å¤ªå‹å¥½äº†ã€‚å¦‚æœèƒ½å¤Ÿé€šè¿‡Battery Historianå®šä½åˆ°å…·ä½“çš„ç”µé‡æ¶ˆè€—çš„å¤§æ¦‚ä½ç½®ï¼Œç„¶åå†é€šè¿‡è¿™ç§æ–¹å¼å»åˆ†æå¯èƒ½æ›´å¥½ä¸€äº›ã€‚

### ç”µé‡ä¼˜åŒ–æ–¹æ¡ˆ

æˆ‘ä»¬é¦–å…ˆæ±‡æ€»ä¸€ä¸‹è€—ç”µçš„ç›¸å…³å› ç´ ï¼š

* å±å¹•çš„äº®æš—
* è®¾å¤‡å”¤é†’ï¼Œç¡çœ çš„åˆ‡æ¢ã€‚å°¤å…¶æ˜¯å”¤é†’
* CPUè¿è¡Œç›¸å…³
* ç½‘ç»œ
* ä¼ æ„Ÿå™¨

æˆ‘ä»¬çŸ¥é“å±å¹•æ¸²æŸ“ä»¥åŠCPUçš„è¿è¡Œæ˜¯è€—ç”µçš„ä¸»è¦å› ç´ ã€‚æ‰€ä»¥å½“æˆ‘ä»¬åœ¨è¿›è¡Œå†…å­˜ä¼˜åŒ–ã€æ¸²æŸ“ä¼˜åŒ–ã€å¸ƒå±€ä¼˜åŒ–ã€è®¡ç®—ä¼˜åŒ–çš„æ—¶å€™ï¼Œå…¶å®å°±å·²ç»åœ¨åšç”µé‡çš„ä¼˜åŒ–äº†ã€‚å› æ­¤åœ¨å¹³æ—¶å¼€å‘çš„è¿‡ç¨‹ä¸­è¦å°½é‡å°‘æŒ–å‘ã€‚

è¿™é‡Œæˆ‘ä»¬ä¼šæ ¹æ®å…·ä½“çš„è€—ç”µå› ç´ æ¥æä¾›ç›¸å…³çš„ä¼˜åŒ–æ–¹å‘ï¼š

##### å±å¹•å¸¸äº® vs å”¤é†’

å½“Androidè®¾å¤‡ç©ºé—²æ—¶ï¼Œå±å¹•å˜æš—ï¼Œç„¶åä¼šå…³é—­å±å¹•ï¼ˆè¿™ä¸ªæ˜¯é€šè¿‡ç”µæºç®¡ç†æ¥å®ç°çš„ï¼‰ï¼Œæœ€ååœæ­¢CPUçš„è¿è¡Œä»è€Œå®ç°èŠ‚çº¦ç”µé‡ã€‚ä½†æ˜¯å½“è®¾å¤‡ä»ä¼‘çœ çŠ¶æ€ä¸­ï¼Œè¢«åº”ç”¨ç¨‹åºå”¤é†’çš„ä¸€ç¬é—´ä¼šè€—ç”µè¿‡å¤šã€‚æ‰€ä»¥æœ‰æ—¶å€™å¯ä»¥ä¿æŒå±å¹•çš„å¸¸é‡æ¥èŠ‚çœç”µé‡ã€‚æ¯”å¦‚è¯´ç©æ¸¸æˆã€‚

ä¿æŒå±å¹•å¸¸äº®æœ€å¥½çš„æ–¹å¼æ˜¯åœ¨ Activity ä¸­ä½¿ç”¨ FLAG_KEEP_SCREEN_ON çš„ Flagã€‚

```java
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
```

è¿™ç§æ–¹å¼ç›¸å¯¹äºå”¤é†’é”ï¼ˆwake locksï¼‰æ¥è¯´ï¼Œä¸å†éœ€è¦æ‹…å¿ƒèµ„æºé‡Šæ”¾çš„é—®é¢˜ã€‚ç”µæºç®¡ç†ç³»ç»Ÿèƒ½å¤Ÿè‡ªåŠ¨çš„ç®¡ç†ä¸åŒçš„APPä¹‹é—´çš„åˆ‡æ¢é—®é¢˜ã€‚

æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ ¹æ®è‡ªå·±çš„APPå®é™…æƒ…å†µæ¥æ§åˆ¶æ˜¯å¦éœ€è¦ä¿æŒå±å¹•å¸¸äº®ã€‚

##### å”¤é†’é”

å°±åƒæˆ‘ä»¬åœ¨åŸºç¡€çŸ¥è¯†é‡Œé¢æ‰€è®²è§£çš„é‚£æ ·ï¼Œå½“ä½¿ç”¨äº†wake locksé”ä»¥åï¼ŒCPUå°±ä¸ä¼šè¿›è¡Œä¼‘çœ ï¼Œä¹Ÿå°±èƒ½è¿‡ä¿è¯CPUå¤„äºå”¤é†’çš„çŠ¶æ€ã€‚ä½†æ˜¯è¿™ç§æƒ…å†µå¯¹ç”µæ± çš„ç»­èˆªåˆæœ‰è¾ƒå¤§çš„å½±å“ï¼Œæ‰€ä»¥é™¤éæœ‰çœŸçš„å¿…è¦ï¼Œå¦åˆ™è¿˜æ˜¯å°½é‡å‡å°‘wake lockçš„ä½¿ç”¨(æ¯”å¦‚æˆ‘ä»¬ä¸Šé¢æ‰€è¯´çš„ä¿æŒå±å¹•å¸¸äº®æ–¹æ¡ˆ)ã€‚

å¯¹äºä¸å¾—ä¸ä½¿ç”¨å”¤é†’é”çš„æ—¶å€™ï¼Œä¹Ÿè¦æ³¨æ„å»åˆç†çš„ä½¿ç”¨ã€‚æ¯•ç«Ÿwakelockç”³è¯·å¿˜è®°é‡Šæ”¾ä¼šé€ æˆæ‰‹æœºè€—ç”µå¤ªå¿«ï¼Œä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒï¼Œç”¨æˆ·çŸ¥é“éª‚å¨˜ï¼Œå‚å•†çŸ¥é“éª‚å¼€å‘ã€‚è¿™é‡Œç»™å‡ºå‡ ç‚¹ä½¿ç”¨æ—¶çš„å‡ ç‚¹æ³¨æ„äº‹é¡¹ã€‚

* å¯¹äºwake lockï¼Œacquireå’Œreleaseè¦æˆå¯¹å‡ºç°ã€‚ä¸ºäº†é˜²æ­¢å¼‚å¸¸å¯¼è‡´æœªé‡Šæ”¾çš„æƒ…å†µå‘ç”Ÿï¼Œå¯ä»¥ä½¿ç”¨try,catch,finallyï¼Œåœ¨finallyä¸­æ¥è¿›è¡Œé‡Šæ”¾ã€‚
* ä½¿ç”¨å¸¦æœ‰å‚æ•°çš„acquireï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´ã€‚ä¸€æ®µæ—¶é—´è¿‡åç”±ç³»ç»Ÿè‡ªåŠ¨è¿›è¡Œå”¤é†’é”çš„é‡Šæ”¾ã€‚

##### CPU

CPUçš„è€—ç”µä¸»è¦æœ‰ä¸¤ç§ï¼š

* é•¿æœŸå¤„äºé«˜é¢‘å·¥ä½œçŠ¶æ€ã€‚å¦‚åŠ¨ç”»çš„å¤„ç†ã€Viewçš„é¢‘ç¹ç»˜åˆ¶ã€å¤æ‚åº¦æ¯”è¾ƒé«˜çš„ç®—æ³•å¤„ç†ç­‰ç­‰
* é¢‘ç¹çš„å”¤é†’ã€‚CPUå”¤é†’ä¼šä½¿ç”¨ç”µé‡æ¿€å¢ã€‚

å¯¹äºCPUçš„ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥é€šè¿‡TraceViewï¼ŒSystraceã€Profileç­‰å·¥å…·æ¥è·å–CPUæ¶ˆè€—æƒ…å†µï¼Œä»è€Œå®šä½CPUä½¿ç”¨å¼‚å¸¸çš„åœ°æ–¹ã€‚é’ˆå¯¹ä»¥ä¸ŠCPUæ¯”è¾ƒè€—ç”µçš„é—®é¢˜æä¾›ä»¥ä¸‹ä¸¤ç§ä¼˜åŒ–æ–¹æ¡ˆï¼š

* å‡å°‘åå°åº”ç”¨çš„ä¸»åŠ¨è¿è¡Œã€‚æ¯”å¦‚è¯´åœ¨è¿›å…¥åå°è¿è¡Œä»¥åå…³é—­åŠ¨ç”»ã€æš‚åœç½‘ç»œè¯·æ±‚ã€‚
* å‡å°‘ç®—æ³•çš„å¤æ‚åº¦ï¼ŒåŒ…æ‹¬æ—¶é—´å¤æ‚åº¦å’Œç©ºé—´å¤æ‚åº¦ï¼ˆè¿™æ—¶å€™ä½“ç°ç®—æ³•çš„ä¸€éƒ¨åˆ†ä½œç”¨äº†ï¼‰ã€‚

##### ç½‘ç»œ

åœ¨ä»‹ç»Energy Profilerå·¥å…·çš„æ—¶å€™ï¼Œæˆ‘ä»¬å‘ç°ï¼Œå…¶å®ç½‘ç»œè¯·æ±‚ä¹Ÿæ˜¯æ¯”è¾ƒè€—ç”µçš„ã€‚æ‰€ä»¥å¯¹äºç½‘ç»œè¯·æ±‚æˆ‘ä»¬æä¾›äº†ä»¥ä¸‹å‡ ç§å¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹ã€‚

* æ§åˆ¶è¯·æ±‚æ¬¡æ•°å’Œè¯·æ±‚æ—¶æœºã€‚

* å¯¹æ•°æ®è¿›è¡Œä¸€å®šçš„å‹ç¼©å¤„ç†ã€æ—¢å¯ä»¥å‡å°‘æ—¶é—´æ¶ˆè€—ä¹Ÿå¯ä»¥å‡å°‘æµé‡æ¶ˆè€—ã€‚
* ç¦æ­¢**é•¿æ—¶é—´**ä½¿ç”¨è½®è®­è¿›è¡Œç½‘ç»œè¯·æ±‚ã€‚*å¥½åƒä½¿ç”¨websocketæ›´åŠ çœç‚¹ä¸€äº›ï¼Ÿ*

ç½‘ç»œè¯·æ±‚ä¸­ï¼Œä¸€äº›ä¸æ˜¯ç‰¹åˆ«ç´§æ€¥çš„ä»»åŠ¡å¯ä»¥é€šè¿‡**JobScheduler**æ”¾åˆ°æ›´åˆé€‚çš„æ—¶æœºå»æ‰¹é‡å¤„ç†ã€‚æ¯”å¦‚è¯´é•¿æ—¶é—´çš„ä¸‹è½½ä»»åŠ¡ã€ç‰¹å®šçš„æ¨é€æœåŠ¡ã€æ—¥æŠ¥è¡¨ä¿¡æ¯ç­‰ç­‰ã€‚

##### ä¼ æ„Ÿå™¨

è¿™é‡Œæˆ‘ä»¬è€ƒè™‘çš„ä¼ æ„Ÿå™¨ä¸»è¦æ˜¯GPSå®šä½ç­‰åŠŸèƒ½ã€‚

ç”±äºGPSä¼ æ„Ÿå™¨æ¯”è¾ƒè€—ç”µï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ ¹æ®å®é™…éœ€è¦è°ƒæ•´å®šä½æ¨¡å¼ã€‚

1. èƒ½ä¸ç”¨åˆ™ä¸ç”¨ã€‚æ¯”å¦‚è¯´ä½¿ç”¨ç½‘ç»œå®šä½æ¥ä»£æ›¿GPS
2. èƒ½å°‘ç”¨åˆ™å°‘ç”¨ã€‚åœ¨GPSçš„å®šä½åŠŸèƒ½ä½¿ç”¨å®Œæˆä»¥åè¦åŠæ—¶å…³é—­ã€‚
3. èƒ½ä½ç²¾åº¦å°±ä¸è¦é«˜ç²¾åº¦ã€‚å¯¹äºå®šä½è¦æ±‚ä¸é«˜çš„ï¼Œç›´æ¥é€‰æ‹©ä½ç²¾åº¦æ¨¡å¼ã€‚

å¯¹äºå…¶ä»–ä¼ æ„Ÿå™¨ï¼Œæ¯”å¦‚è¯´è“ç‰™ç­‰ï¼Œä¹Ÿæ˜¯ç›¸ä¼¼çš„åŸç†ã€‚

### æ€»ç»“

ç”µé‡ä¼˜åŒ–ç›¸å¯¹[å†…å­˜ä¼˜åŒ–](https://mp.weixin.qq.com/s?__biz=MzUzOTE4MTQzNQ==&mid=2247483865&idx=1&sn=5f0add89bdd03783d78bd8451ae85a97&chksm=facd29cdcdbaa0db462e645a15353da175fb3b7553c0b0cb9a982cbefb1eed0dd18495d155e4&token=497534780&lang=zh_CN#rd)å’Œ[UIä¼˜åŒ–](https://mp.weixin.qq.com/s?__biz=MzUzOTE4MTQzNQ==&mid=2247483909&idx=1&sn=7250d069d8b5b5ef97917dda5df09d4f&chksm=facd2a11cdbaa3073f110544f3854c0a194d60021c5acca56d0750922a84e47726f04f289d14&token=497534780&lang=zh_CN#rd)æ¥è¯´æ¯”è¾ƒç®€å•ä¸€äº›ï¼Œä¸»è¦æ˜¯æ³¨æ„å¯¹äºä¸€äº›è€—ç”µå› ç´ çš„ä½¿ç”¨åœºæ™¯ã€‚å…¶å®åœ¨æˆ‘ä»¬è¿›è¡Œå¸ƒå±€ä¼˜åŒ–ã€å†…å­˜ä¼˜åŒ–ã€å¯åŠ¨ä¼˜åŒ–ç­‰å„ç§æ€§èƒ½ä¼˜åŒ–æœ¬èº«å°±æ˜¯ç”µé‡ä¼˜åŒ–çš„ä¸€ç§æ–¹å¼ã€‚

### å‚è€ƒ

[Android P ç”µé‡ç®¡ç†](https://mp.weixin.qq.com/s?__biz=MzAwODY4OTk2Mg==&mid=2652046811&idx=1&sn=f0340e6fabb07a3ee40db45bdd58e7b0&chksm=808ca59eb7fb2c883c6ae99be7c84460f48886cd79bb0de886a5bac84afa2d8050a58339cc89&scene=38#wechat_redirect)

[Androidå¼€å‘ä¸­çš„ç”µé‡å’Œå†…å­˜ä¼˜åŒ– (Googleå¼€å‘è€…å¤§ä¼šæ¼”è®²PPT&è§†é¢‘)](https://mp.weixin.qq.com/s?__biz=MzAwODY4OTk2Mg==&mid=2652041067&idx=5&sn=586dccf83420759ffae3d5ede6b99f06&chksm=808d4f2eb7fac63880b321eb60d2b8177f0ebdec24459a348feec39c549504225fdf1eda1a67&scene=38#wechat_redirect)

[æ·±å…¥æ¢ç´¢ Android ç”µé‡ä¼˜åŒ–](https://juejin.im/post/5ee8103b6fb9a047a64476e6#heading-66)

[Energy Profilerç”µé‡æ£€æµ‹](https://developer.android.google.cn/studio/profile/energy-profiler)

[ä½¿ç”¨Battery Historianå·¥å…·åˆ†æAndroidè€—ç”µåˆ†æ](https://www.jianshu.com/p/2f144bf7fe51)

[android PowerManageråˆ†æ](https://blog.csdn.net/forebe/article/details/79397251)

[Androidç”µé‡ä¼˜åŒ–å…¨è§£æ](https://www.jianshu.com/p/c86021fe958d)

[BugReport è€—ç”µåˆ†æ](https://www.jianshu.com/p/b84f2fb98340)

[Topå›¢é˜Ÿå¤§ç‰›å¸¦ä½ ç©è½¬Androidæ€§èƒ½åˆ†æä¸ä¼˜åŒ–](https://coding.imooc.com/class/308.html)

> æœ¬æ–‡ç”± [å¼€äº†è‚¯](http://www.kailaisii.com/) å‘å¸ƒï¼ 
>
> æ–‡ç« GitHubä»“åº“ï¼š[è¾“å‡ºæ–‡ç« ](https://github.com/kailaisi/Android-Guide/tree/master/%E8%BE%93%E5%87%BA%E6%96%87%E7%AB%A0)
>
> åŒæ­¥å…¬ä¼—å·[å¼€äº†è‚¯]

![image-20200404120045271](http://cdn.qiniu.kailaisii.com/typora/20200404120045-194693.png)