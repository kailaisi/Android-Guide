网络优化

认识

* 网络优化的维度：多维的
* 仅仅重视流量消耗
* 网络流量的消耗量：要精确，不仅仅是均值。均值经常掩盖单点问题
* 网络监控：要全面，不仅仅是粗粒度的。

优化维度

* 流量消耗：
  * 一段时间内流量消耗的精准度：网络类型，前后台等
  * 流量监控：用户流量消耗均值、异常率（消耗过多，次数多，文件流量过大等等）
  * 完整大的链路监控（request，response），并且能够进行主动上报（线上拉取或者发现异常之后的主动上报）
* 请求质量
  * 用户体验：请求速度，成功率等
  * 监控相关：请求时长，业务成功率，失败率，Top失败接口等等
* 其他
  * 公司成本：带宽、CDN、服务器数
  * 应用耗电量等

网络优化误区

* 只关注流量消耗，而忽视了其他维度
* 只关注均值、整体，忽视个体的问题



#### 优化工具

##### Network Proiler

* 显示实时网络活动：发送、接收数据及连接数
* 需要启用高级分析
* 只支持HttpURLConnection和OkHttp网络库

##### Charles

* 断点功能：能够动态修改请求以及返回信息
* maplocal：能够mock数据
* 弱网模拟

##### Stetho

* 强大的应用调试桥，连接Android和Chrome
* 网络监控、视图查看、数据库查看、命令行扩展等等

##### Fidder



### 流量

#### 高低判断

* 绝对值看不出高低
* 可以和竞品进行分析，相同Case情况下对比流量消耗
* 异常监控，超过正常指标了

#### 测试方案

* 设置-流量管理。只允许本app联网
* 抓包工具：只允许本APP联网
* 可以解决大多数问题，但是线上场景线下可能遇不到

#### 线上流量获取方案

* TraffficStats：API8以上可以统计重启以来的流量数据统计，无法获取某个时间段内的流量消耗
  * getUidRxBytes（int uid）指定Uid的接收流量
  * gettotalTxBytes（）总发送流量
* NetworkStatusManager：API23之后的流量统计，弥补了TraffficStats的不足，可以线上使用
  * 可以获取指定时间内的流量信息
  * 可以获取不同网络类型下的消耗

#### 前后台流量获取

难点：

* 线上反馈跑流量，但是无法统计是前台还是后台

* 只获取一个时间段的不够全面

方案：启动后台任务，获取间隔内的流量，记录前后台，然后分别计算，并上报APM后台

问题：

* 有一定误差，在统计间隔内，用户可能频繁切前后台，但是误差在可接受范围之内
* 结合精细化的流量异常报警针对性的解决后台跑流量的问题

### 流量使用场景

* 数据：Api，资源包（升级包、H5、RN）、配置信息
* 图片：上传下载
* 监控：APM相关、单点问题相关

#### 网络请求流量优化技巧：

##### 缓存

* 服务器返回加上过期时间，避免每次都重新获取
* 节约流量且大幅提高数据访问速度，更好的用户体验
* OkHttp、Volley都有较好的的实践

##### 增量数据更新

* 加上版本的概念，只传输有变化的数据
* 配置和信息，省市区县等更新

##### 数据压缩

* Post请求的Body使用GZip压缩
* 请求头压缩，只传输一次，只使用md5值。有变化的时候再去传输
* 图片上传之前进行压缩

##### 优化发送频率和时机

每次网络请求都有一些冗余信息的产生。

* 合并网络请求、减少请求次数
* 性能日志上报：批量+特定场景才上报

##### 图片专项优化

* 图片使用策略细化：优先使用缩略图
* 使用WebP图片

#### 网络请求质量优化

##### 质量指标

* 网络请求成功率
* 网络请求速度（Http请求过程）
* 质量监控
  *  接口请求耗时、成功率、错误码
  * 图片加载每一步的耗时

* **通过OkHttp的EventListener来监控对应的请求时间等等**
* **Freso的RequestListener来监控图片的信息**

##### 提升请求质量方法

* 使用HTTPDNS
  * DNS劫持、DNS解析慢，
  * 可以使用HttpDNS，绕过运营商域名解析过程。
  * 优势：降低平均访问时长、提高连接成功率

* 其他
  * CDN加速、提高带宽、动静资源分离
  * 减少传输量，注意请求时机和频率
  * OkHttp的请求池（线程并发上限的）

### 体系化方案建设

#### 测试

* 线下测试：
  * 单APP测试
  * 重点：网络切换、弱网、无网络情况，请求多余、有误
* 线上监控
  * 服务端：
    * 请求耗时（区分地域、时段、版本、机型）
    * 失败率（业务失败和请求失败）
  * 客户端
    * 接口每一步详细信息：DNS，连接，请求，数据大小
    * 请求次数、网络包大小、失败原因等
    * 图片监控
  * 异常监控体系  
    * 服务器防刷：超限拒绝访问
    * 客户端：大文件预警，异常兜底策略。
    * 单点问题追查