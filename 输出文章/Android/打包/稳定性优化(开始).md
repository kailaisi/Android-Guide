稳定性优化

对于APP的稳定性，重在预防、贵在治理。长期通过一定的流程来进行持续的优化。

* 开发阶段
* 测试阶段
* 发布阶段
* 运维阶段
* 降级容灾

### 开发阶段

技术评审、CodeReview机制、主动容错处理

#### 技术评审

* 以技术角度评估项目 功能实现，业务架构，可能遇到的重难点，可以采取的降级策略进行认证。
* 重要逻辑统一两端的实现方式。

可取的降级策略：

兜底策略：首次安装，网络请求失败的话，此时展示跟包数据。

缓存策略：先展示缓存数据--------再更新接口数据------接口失败再考虑兜底策略

远程开关：通过配置平台配置开关，清除脏数据。

#### 主动容错

一些问题，到了用户或者测试手上之后总是问题不断。究其原因：1是数据源出了问题，另外是我们对这些部分没有主动进行容错处理。通常需要我们进行异常捕捉，**也许可能导致某个功能无法正常使用，但是终究不会引发崩溃**。

1. 字符串、数组、集合：越界、空指针。可以通过工具类来进行封装
2. 数据转换。
   * 空数据，数据不匹配等等。
3. 生命周期：页面关闭之后的异步任务回调导致的NPE

#### 强制Code review机制

好处：

1. 学习别人代码，开阔思路，提升代码健壮性，改掉边界考虑不周的情况
2. 对于测试测不到的bug提前修复，降低线上bug和crash率
3. 在code review会议中集思广益，促进团队交流，营造团队协作的团队氛围。

### 测试环节

* 功能测试check-list、回归测试、覆盖安装测试、边界特殊场景测试（弱网络等）、机型兼容测试
* 云测平台提供多种机型，进行兼容性，性能自动化测试

### 发布阶段

* 灰度系统-逐步放量，观察灰度版本的crash情况，发现并解决问题
* 多轮灰度
* ABTest测试，一半用户接入优化逻辑，一半用户不接入

### 运维阶段

每个程序上线必然会存在问题。所以上线之后的日志收集就比较重要了。

##### Crash监控日志采集

* 启动流程、重点流程Crash
  * 处理策略：启动阶段的crash建设安全模式，重点流程的crash进行告警机制
* 增量、存量crash
  * 新增：新增的crash->新版本的重点
  * 存量：老版本就存在的crash>继续啃的硬骨头
  * 处理策略：优先解决增量、持续跟进存量
* crash日志收集
  * 三方平台，比如说友盟，bugly.....
  * 自己封装UncaughtException，然后上传到自己的服务器

##### 非Crash的异常监控日志采集

用户反馈的 点击页面无反应，功能按钮不显示，流程不正确，非crash的异常问题，无法复现，很难排查。

建设客户端的运行时日志体系，按需回捞——，以打点的形式记录关键的执行流程

* catch代码块（catch导致的功能不可用）
* 异常逻辑（某个方法返回false导致的功能不可用）
* 逻辑分支（如执行了else逻辑导致操作流程不正确） 

```java
try{
	//业务处理
}catch(Exception e){
     XLog.info("**.class happen exception on *() method")
}
//逻辑处理
if(flag){
    XLog.info("execute norml logic")
}else{
    XLog.info("execute downgrade logic")//记录要执行降级策略
}
```



##### 报警策略

* 阈值报警：crash率超过了某个值，或者反馈超过多少数量，异常率超过一定次数
* 趋势报警：如果昨天比今天的异常对比，超过多少个百分比以后报警。

```java
try{
}catch(Exception e){
	//打点上报，包括模块名，页面名称，方法名称异常信息的描述等等。
}
```

##### 降级容灾

###### 配置平台

* 配置中心，功能开关。在可视化的配置平台配置开关字段和它的值。APP启动的时候拉去最新的配置数据

###### 安全模式

根据crash信息自动恢复，多次启动失败后，重置App

```java
//1. 通过UncaughtException记录崩溃
//2. 在Application中进行处理
private int crashTimes;

protected void attachBaseContext(Context context){
	super.attachBaseContext(context);
	if(crashTimes>3){
		//删除文件
		//删除配置
		//删除补丁
		//删除动态下载的资源so文件
		//重置到新安装的状态
	}
}
```

##### 统调中心

* 模块化开发的路由，有问题的页面不进行跳转或者跳转至统一的提示页面

##### 热修复

* 热修复
* Weex，RN增量更新
* 动态化组件VirtualView更新组件