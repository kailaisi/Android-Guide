## Android瘦身优化

### 前言

#### 瘦身优势

影响最多的是转换率：下载转化率。

头部App有Lite版本

渠道合作商要求

### APK组成

代码相关：classes.dex

资源相关：res、asserts、resources.arsc

so相关：so文件

### APK分析

* ApkTool，反编译工具。
* Analyze APK：AS2.2之后
  * 位置：Build->Analyze APK
  * 查看Apk组成、大小、占比
  * 查看Dex文件组成
  * Apk对比
* APP性能分析网站：https://nimbledroid.com/ 
  * 文件大小及排行
  * Dex方法数和SDK方法数
  * 启动时间、内存等
* android-classyshark：二进制检查工具
  * 支持多种格式：apk，jar，class,so等
  * 使用非常便捷
  * 源码比较简略

### 瘦身实战

#### 代码瘦身

##### **混淆**

> 代码混淆也称为花指令，是将计算机程序的代码转换为功能上等价但是难以阅读、理解的行为。Proguard是一个免费的Java类文件压缩、优化、混淆、预先验证的工具，可以检测和移除未使用的类、字段、方法、属性，优化字节码并移除未使用的指令，并将代码中的类、字段、方法的名字改为简短、无意义的名字。

**混淆方法**

开启Proguard混淆。

注意：对于Proguard，虽然效果明显，但仍然需要谨慎

>* 代码混淆会拖慢构件速度，所以debug模式下要关掉。
>* 在debug因为没有混淆。那么在Release模式下可能会出现debug模式下不出现的bug。
>* Proguard最好在项目初期就建立起规范。防止后期需要增加大量的混淆规则。

##### **三方库处理**

**基础库统一**：去掉多余的库，避免出现多套网络请求、图片加载等类库

**无用的库要移除**：可能由于迭代会不再使用某些依赖的库。这时候要移除。

。。todo  这个要如何确定呢？

**选择更小的库**：picicss库更小，Android Method Count插件可以查看引入的库的大小

todo...这个要如何确定呢？

**仅引入所需的部分代码**：通过exclude移除部分支持。

todo通过具体的代码实现

**拷贝源码进行使用**：有时候可能我们只是使用了部分功能，那么可以下载源码，只拷贝保留比较少的文件来进行阉割处理

##### 移除无用代码

随着版本迭代，一般可能会存在以下问题：

* 代码业务只加不减
* 代码太多不敢删除

其实要根据实际情况，**移除无用代码以及无用的功能，减少代码量，最直接的提现就是Dex的体积会变小**。

#### 资源瘦身

资源和代码同样重要，但是从优化效果来讲，**资源文件的瘦身效果比代码瘦身效果更好**。

##### 冗余资源移除

无用的资源文件的查找和移除相对于代码来说更加容易。

右键,Refactor,Remove Unused Resource，preview。可以预览无用的资源。

##### Drawable目录只保留一份

todo.这里需要进行一下研究

##### 图片压缩

* 快速发展期的App没有相关规范，导致图片可能使用的都是原图
* 图片压缩：https://tinypng.com以及TinyPngPlugin压缩插件
* 图片格式的选择。
  * Webp会有大幅度的压缩。
  * PNG是无损格式，如果图片比较艳丽，那么图片就比较大
  * JPG是有损格式，图片艳丽时，图片相对小一些
* 图片，右键，convert to webp将图片转化为webp格式

**资源混淆**

* AndResGuard
  * 能够使冗长的资源路径（图片名）变短
* 图片只保留一份
* 图片放在云端，在线加载

#### So瘦身

So是Android上的动态链接库。

##### so移除

Android支持7种CPU架构。理论上对应架构的so的执行效率最高。但是会增加文件大小

abiFilter:设置支持的So架构，一般选择armeabi（万金油）。

##### 最优方案

对性能敏感的模块，都放在armeabi目录，根据CPU类型加载对应架构的so文件。这种是因为如果某个so使用了x86的话，会要求所有的其他模块也都要有x86的so文件，否则就会崩溃。所以只对敏感模块的so做这种处理。

这样即减少了Apk的体积，也不影响性能敏感模块的执行。

##### 动态加载so文件

发布的 APK 不包含 Native 代码，启动时根据不同的架构下载相应的 so 文件。

##### 插件化

通过插件化，实现不同模块的动态下发。从而从根源上解决到包过大的问题。

### 参考

https://www.jianshu.com/p/99f3c09982d4