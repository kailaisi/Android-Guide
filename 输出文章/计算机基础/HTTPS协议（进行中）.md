#### HTTPS协议详解

HTTP是明文传输的，对于一些敏感信息会被提取，造成泄漏。所以现在大部分应用已经使用HTTPS来替代HTTP了，关键就是因为其安全性。关于HTTP协议的相关知识，不了解的可以去补充一下[透视HTTP协议](透视HTTP协议.md)

#### 基础知识

##### TLS/SSL

安全套接层：OSI的第五层（会话层）

SSL的第三版V3，变名为TSL。所以TSL 1.0就是SSL V3.1。

**TSL的发展是紧跟密码学的发展和物联网的现状的**

现在最广泛的是TSL的1.2版本，之前的被认为是不安全的。会在2020年被废弃。

TLS由记录协议、握手协议、警告协议、变更密码规范协议、扩展协议等几个子协议组成，综合使用了对称加密、非对称加密、身份认证等许多密码学前沿技术

浏览器和服务器在使用TLS建立连接的时候，会选择一组恰当的加密算法来实现安全通信。这些算法的组合被称为“密码套件”。

最后的格式是固定的：**基本的形式是“密钥交换算法 + 签名算法 + 对称加密算法 + 摘要算法”**

比如说最后协商的是：ECDHE-RSA-AES256-GCM-SHA384。

##### OpenSSL

一个开原密码学程序库和工具包。很多应用软件都使用它来作为底层库来实现TLS功能。

##### 加密算法

对称加密：AES、DES等等

非对称加密：DSA、RSA、ECC（在安全性和性能上都有明显的优势）。

相对于对称加密，非对称加密都是基于复杂的数学难题，所以运算速度都慢一些

##### 数字签名和证书

###### 摘要算法

：MD5、SHA-1、SHA-2。

完整性：通过数据+摘要算法能够保证数据的完整性。

###### 数字签名

私钥+摘要算法，来实现数字签名。数字签名是使用私钥进行加密，公钥进行解密

因为私钥加密效率低，所以私钥只加密原文的摘要信息。

###### 数字证书

由于使用公钥解密，所以对于**公钥信任**问题进行处理。需要通过CA来认证，形成**数字证书**。

#### 简介

Https是运行在SSL/TLS协议上的HTTP。这里的HTTP不再是之前所说的的TCP/IP之上的协议了。而是说HTTP运行在SSL协议之上，而SSL协议运行在TCP/IP协议之上。SSL是一个安全层。

SSL/TLS的本质，是**通过一套非对称加密协议来协商出一套对称加密协议**，然后后续的数据都是通过对称加密协议来进行传输。

这里并不是每次数据通讯都采用非对称加密协议，是因为非对称加密协议的算法比较复杂，会有一定的性能消耗。

#### 通讯连接过程

##### Client Hello

客户端会向服务端发起一个Client Hello信息。表示想向Server端建立连接。

在发送Client Hello信息的时候，还会有一些其他的附加信息，比如说：客户端可选的TLS版本；可选的加密套件列表（包括可选的对称加密算法，可选的非对称加密算法，可选的hash算法）和客户端随机数。发送附加信息是告诉服务器当前自己支持的一些算法。

![image-20210313230003636](http://cdn.qiniu.kailaisii.com/typora/20210313230005-522362.png)

##### Server Hello

当服务器端接收到消息之后，会和自己支持的加密算法进行比对，如果都不符合，则断开连接。否则，服务端会在加密套件列表中选择一个自己支持的加密套件（包括一种对称算法、一种公钥算法和一种Hash算法发）。

随后会向客户端发送一个**Server Hello信息**。附带上**选择的加密套件**，并且生成一个服务器端的**随机数**。

![image-20210316211851453](http://cdn.qiniu.kailaisii.com/typora/20210316211853-890239.png)

##### 服务器证书

当服务端和客户端协商好所使用的加密套件之后，服务端会将自己的服务器证书（**关键是服务器公钥和服务器主机名**）发送给客户端。**客户端会验证证书是否合法**。

![image-20210316215211726](http://cdn.qiniu.kailaisii.com/typora/20210316215212-825148.png)

##### **client_key_exchange+change_cipher_spec+encrypted_handshake_message**

先看下wireshark抓到的数据，然后再进行对应的说明

![image-20210317222809295](http://cdn.qiniu.kailaisii.com/typora/20210317222809-331732.png)

* client_key_exchange：当验证完证书合法性之后，客户端会生成一个随机数Pre-master secret，然后使用服务端发送过来的服务端公钥进行加密。并将加密后的数据发送给服务器端。
* 客户端根据：pre-master secret +服务器随机数+客户端随机数，计算得到协商之后的密钥（对称加密密钥，之后的通讯都使用该密钥）
* change_cipher_spec：客户端通知服务器后续的通信都采用协商的密钥和加密算法进行通信。
* encrypted_handshake_message：结合之前所有通讯参数的hash值和其他信息，生成一段数据。然后采用对称加密算法对其加密，发送给服务器用于数据和握手验证。

##### change_cipher_spec+encrypted_handshake_message

先看下wireshark抓到的数据

![image-20210317222909164](http://cdn.qiniu.kailaisii.com/typora/20210317222909-266447.png)

* 服务器用私钥解密得到Pre-master secret，然后pre-master secret +服务器随机数+客户端随机数，计算得到协商之后的密钥（对称加密密钥，之后的通讯都使用该密钥）
* 计算之前所有接收到的信息的hash值，解密客户端发送来的encrypted_handshake_message数据，验证其数据和密钥的合法性
* change_cipher_spec：验证通过后，同样的服务器发送change_cipher_spec告知客户端后续的通信都采用协商的密钥和加密算法进行通信。
* encrypted_handshake_message,：服务器也结合所有当前的通信参数信息的hash值和其他信息生成一段数据并采用协商密钥与算法加密并发送到客户端

##### 结束握手

当客户端计算所接收到的hash，并采用解密密钥进行解密，验证服务器发送的数据和密钥是否正确，如果验证通过，则握手完成

##### 加密通讯

当验证通过，握手完成之后，客户端和服务端就可以通过协商好的加密密钥对传输的数据进行加密工作了。

我们看看具体的数据

![image-20210317223039186](http://cdn.qiniu.kailaisii.com/typora/20210317223039-945381.png)

https://blog.csdn.net/hherima/article/details/52469674

仍物线第五期

