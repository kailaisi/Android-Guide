### 计算机网络

### 发展历史

#### 互联网发展历史

* 单个网络
* 三级结构互联网
* 多层次ISP互联网

#### 中国互联网发展简史

* 1980开始互联网实验
* 1989第一个公共网络建立运行
* 1994接入国际互联网

### 计算机网络的层次结构

#### 基本原则

基本原则

* 保证数据同路顺畅
* 识别目的计算机
* 目的计算机状态
* 数据是否错误

分层实现不同的功能

层次结构设计原则：

* 各层之间相互独立
* 每一层有足够的灵活性
* 各层之间完全解耦

#### OSI七层模型

应用层：为计算及用户提供接口和服务

表示层：数据处理（编解码、加密解密等）

会话层：管理（建立、维护、重连）通信会话

传输层：管理端到端的通信连接

网络层：数据的路由

数据链路层：管理相邻节点之间的数据通信

物理层：数据通信的光电物理特性

#### TCP/IP四层模型

应用层（应用层、表示层、会话层）：HTTP/FTP/SMTP/POP3

传输层:TCP/UDP

网络层:IP

网络接口层（数据链路层、物理层）:Etherent /PPP

![image-20200818205506921](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20200818205506921.png)

### 现代互联网的网络拓扑

客户端/服务器模式

P2P模式

### 计算机性能指标

#### 网速

#### 时延

发送时延：受限于计算机网卡

传播时延：路径距离/传播速率。受限于传输介质

排队时延：网络设备中等待被处理的时间。

处理时延：到达目的机器被处理所需要的时间

#### 往返时间：RTT

通过ping来查看

### 物理层

#### 作用

* 连接不同的物理设备。
* 传输比特流

##### 介质

双绞线、光纤、同轴电缆、红外线、无线、激光

#### 信道的基本概念

* 信道是往一个方向传送信息的媒体
* 一条通信电路包含一个接收信道，一个发送信道。

单工通道：有线电视、无线电收音机。

半双工：

全双工：

#### 分用-复用技术

提升信道的利用效率

![image-20200818212356728](http://cdn.qiniu.kailaisii.com/typora/20200818212402-713920.png)

频分复用、时分复用、波分复用、码分复用。

### 数据链路层

#### 封装成帧

* 帧是数据链路层数据的基本单位
* 发送端在网络层的一段数据前后添加特定的标记形成“帧”
* 接收端根据前后的特定标记识别出“帧”

#### 透明传输

用于处理帧数据中存在着帧首部或者帧尾部的数据

* 存在但是看起来不存在一样。
* 即控制字符在帧数据中，但是要当成不存在去处理

帧数据增加转义字符来进行特殊处理

#### 差错检测

*  物理层只管传输比特流，无法控制是否出错
* 负责“差错检测”工作。

##### 奇偶校验码

在比特流后面增加一个奇偶校验码位。

存在缺陷。

##### 循环冗余校验码CRC

采用模2除法

1. 选定校验的多项式，在数据尾部增加r个0
2. 将添加0之后的数据，使用模2除法除以多项式的位串
3. 得到的余数填充在原r个0位置得到可校验的位串

CRC的错误检测能力跟多项式的阶数有关。

**数据链路层只对数据进行检测，并不进行纠正。纠正操作交给了更上一层来处理**

#### 最大传输单元MTU

##### MTU

数据链路层的数据帧不是无限大的。MTU描述它能够传输的最大值。

过大或者过小都会影响传输的效率。以太网的MTU一般是1500字节。

#### 以太网协议详解

是数据链路层使用的协议。

##### MAC地址

MAC地址是物理地址，每个设备都有唯一的MAC地址，MAC地址有48位，使用16进制表示。

##### 以太网协议

* 以太网是一种广泛使用的局域网技术
* 应用于数据链路层的协议
* 可以完成***相邻设备***的数据传输

对于跨节点的传输，以太网协议是没有办法去进行寻址的，需要网络层来进行处理。

### 网络层

解决数据路由问题，决定数据在网络的路径。

路由器是网络层的重要硬件设备。

#### IP协议

虚拟互联网络的提出：

* 实际的计算机网络错综复杂
* 物理设备使用IP协议，屏蔽了物理网络之间的差异
* 当网络中的主机使用IP协议连接时，无需关注网络细节

##### IP协议

IP协议使得复杂的实际网络变为一个虚拟互联的网络

IP协议使得网络层可以屏蔽底层细节而专注网络层的数据转发

IP解决了在虚拟网络中数据报传输路径的问题。

**MAC地址**

不可变的

**IP地址**

可变的

**IP数据报**

帧是网络传输中的最基本单元。而帧中的“帧数据”则是**IP数据报**，IP数据报则分为**IP首部**和**IP数据报的数据**。

**IP首部：**

* 4位版本
* 4位首部长度（最大数值为15。单位是32位字，也就是4个字节。所以首部长度最多为15*4=60个字节）
* 8位服务类型
* 16位总长度。表示IP协议最大长度位65535，超过了MTU的话，会将IP协议的数据进行拆包处理。3位标志位+13位的片偏移
* 8位生存时间（TTL）。没经过一个设备TTL减一，=0的时候，网络设备丢弃报文。
* 8位协议。表明IP数据所携带的具体数量是什么协议（如TCP、UDP协议等）
* 16位首部校验和：校验数据正确性
* 32位源IP地址
* 32位目的IP地址
* 选项数据

##### IP协议转发

IP路由的选择是逐跳（hop-by-hop）进行的。

**路由表**

* A通过网卡发出数据帧
* 数据帧达到路由，路由器取出前6个字节
* 路由器匹配MAC地址表，找到对应的网络接口
* 路由器往网络接口发送数据帧

**转发流程**

* A通过路由表发现下一跳为E， 
* A将IP数据报交给数据链路层，并告知目的MAC地址是E
* 数据链路层天成MAC地址A和目的地址E
* 数据链路层通过物理层传给E
* E的数据链路层接收到数据帧，把帧数据交给网络层
* E的网络层通过路由表，发现下一跳为F
* ....

#### ARP协议

ARP地址解析协议

如果进行路由跳转的时候，路由检查MAC地址表，没有对应的C的信息，那么就会发送广播，然后接收到广播的设备会返回对应的MAC地址信息，然后会进行地址记录

ARP的数据报文是直接封装在数据链路层的帧数据中的。

#### RARP协议

用于将MAC地址解析为网络层32位的IP地址

(R)ARP协议是TCP/IP协议栈里面基础的协议。

#### 子网划分

##### 分类的IP地址

* A类：网络号8位，首位是0
* B类：网络号16位，前两位是10
* C类：网络号24位，前三位是110

特殊的主机号

* 全为0表示当前网络段
* 全为1表示广播地址

如果某个公司有256个员工，那么只能申请B类，但是他有2^16个子网，会造成浪费。从而引入了子网。

划分为：0-127   和128-254

##### 子网掩码

##### 无分类编址CIDR

#### NAT技术

NAT网络地址转换。用于多个主机通过一个公有IP访问互联网的私有网络

主要是为了解决IP地址不够用的问题。

* IP最多有40亿个
* 前期的IP分配不合理导致了极大的浪费。

内网地址

* 内部机构使用
* 避免与外网地址重复

外网地址

* 全球范围使用
* 全球公网唯一

转换方案：

![image-20200821165736098](C:\Users\wu\AppData\Roaming\Typora\typora-user-images\image-20200821165736098.png)

主要是通过端口号来进行不同内部网络机器的处理。

##### ICMP协议

网际控制报文协议

可以报告错误信息或者异常情况。

ICMP协议的内容是封装在IP数据包的数据中的。会在IP协议的协议头部分写入对应的字段来标识是ICMP协议

通过*tracert github.com*可以查看具体的路由跳过的各个ip地址信息

#### IP路由算法

用来计算路由对应的下一跳的具体的地址信息。

要求：

* 算法是正确的，完整的
* 在计算上应该尽可能的简单
* 可以适应网络中的变化
* 算法是稳定和公平的

自治系统：内部的系统自己进行系统的处理。

运行在系统内部的：内部网关协议（RIP、OSPF）

运行在系统外部的：外部网关协议（BGP）

### 传输层

给应用层提供应用服务。属于用户可以使用的最底层。用于管理端到端的通信连接。主要包含UDP和TCP协议

##### 概念

使用端口来标记不同的网络进程。

#### UDP协议

* 用户数据报协议。
* 是一个简单的协议。无连接协议，不能保证可靠的交付数据
* 面向报文传输。会将应用层的数据直接封装为UDP的数据报的数据
* 没有拥塞控制。
* 首部开销小。

数据报（Datagram）：是应用层传输的一个最基本的报文信息。

![image-20200821221633975](http://cdn.qiniu.kailaisii.com/typora/20200821221634-61834.png)

**UDP的首部**

* 16位源端口号、
* 16位目的端口号、
* 16位UDP长度、
* 16位UDP校验和、
* UDP数据

#### TCP协议

传输控制协议。是计算机网络中比较复杂的一个协议。

* 面向连接的协议
* 连接两端的点到点的通信
* 提供可靠的传输服务
* 提供全双工的通信
* 面向字节流的协议。会对客户的报文进行拆分或者组合。

TCP的首部

![image-20200821222854202](http://cdn.qiniu.kailaisii.com/typora/20200821223039-576002.png)

#### 等待停止协议

每发送一个消息，都会等待接收方返回的确认消息，当收到确认消息以后才进行下一个传输帧的发送。

会发生3种情况：

* 发送丢失
* 确认丢失
* 确认超时

每发送一个消息，都需要设置一个定时器（**超时定时器**）。

停止等待协议是最简单的可靠传输协议。但是对信道的利用效率不高。

#### 连续ARQ协议

自动重传请求协议，是在等待停止协议的基础上改进的。

等待停止协议每次都发送一个报文信息，然后等待消息的确认。因此对于信道的利用率并不高。而ARQ协议则会批量进行报文的传输和确认。

**累计确认VS滑动窗口**

#### TCP的可靠传输

TCP的可靠传输是基于连续ARQ协议

TCP的滑动窗口是以字节为单位的。

**选择重传**

滑动窗口如果后面的接收到，而前面的没有收到的话，仍然会重传所有的滑动窗口中的数据，这种可靠传输的效率并不会特别高。所以出现了选择重传。

 选择重新会选择一部分消息进行重新传输。

选择重选需要指定需要重传的字节，每个字节都有唯一的32位序号。

#### TCP协议的流量控制

流量控制是TCP特有的。

流量控制是指：接收方让发送方发送速率不要太快。是通过滑动窗口来实现的。

在TCP协议的首部，有一个窗口字段，指明允许对方发送的数据量。

**坚持定时器**：当发送方接收到窗口为0的消息的时候，启动坚持定时器，定时器每隔一段时间发送一个**窗口探测报文，检测窗口是否调大了。**

#### TCP的拥塞控制

* 一个数据链路经过的设备非常多。而且链路中的各个部分都有可能成为网路传输中的瓶颈。

流量控制考虑点对点的通信量的控制。而拥塞控制考虑整个网络。

控制方案：

##### 慢启动算法

* 有小到大逐渐增加发送数据量
* 每收到一个报文确认，就指数增加1（即*2）。达到拥塞阈值就通过拥塞避免算法增加窗口大小。

##### 拥塞避免算法

* 维护一个拥塞窗口的变量
* 只要网络不拥塞，就尝试着将拥塞窗口调大。

#### TCP三次握手

在TCP的首部，包含了**TCP标记**。而三次握手主要就是使用这个标记。

![image-20200822154406490](http://cdn.qiniu.kailaisii.com/typora/20200822154409-38080.png)

三次握手的建立。

![image-20200822155920955](http://cdn.qiniu.kailaisii.com/typora/20200822155921-680840.png)

为什么需要三次握手？

* 已经**失效的连接请求报文**传送到对方，**引起错误**

#### TCP四次挥手

TCP连接的释放需要进行4次挥手。

![image-20200822160704296](http://cdn.qiniu.kailaisii.com/typora/20200822160705-201775.png)

**等待计时器的作用**：最后一次挥手是没有确认机制的，所以不知道接收方是否接收到了对应的状态。所以启动计时器。如果最后一次的挥手丢失了，那么接收方会重新发送第三次挥手的数据，然后发送方重新组装第四次挥手的数据。如果在TIME_Wait时间内没有接收到任何数据则默认接收方已经接收到第四次挥手的数据了。

### 应用层

应用层是面向用户的一层，协议有：FTP，HTTP，HTTPS，DNS ，Telnet。

主要用来定义应用间通信的规则。

#### DNS

DNS是域名系统，将域名和IP地址进行关系的映射

**域名**

* 域名由点、字母和数字组成
* 点分割不同的域
* 域名分为顶级域、二级域、三级域

#### DHCP协议

DHCP：为临时设备提供临时IP地址

* 动态主机设置协议。
* 局域网协议
* 是UDP协议的应用层协议

##### 自动IP地址发现

DHCP提供了即插即用联网，不需要手动设置IP地址，只要设置DCHP协议，那么就可以自动联网。实现方式如下：

1. DHCP服务器监听默认端口：67
2. 主机使用UDP协议广播DHCP发现报文
3. DHCP服务器发出DCHP提供报文。
4. 主机向服务器发送DHCP请求报文
5. DHCP服务器回应并提供IP地址。

#### HTTP协议

HTTP：超文本传输协议。是应用层使用最广泛的协议。 

#### HTTPS

HTTP是明文传输的，对于一些敏感信息会被提取，造成泄漏。

HTTPS是安全的HTTP协议。使用的是https://.

##### 加密模型

对称加密：加密解密使用的密钥一致。

非对称加密：加密解密的密钥不一样。

##### 数字证书

是**可信任组织**颁发给**特定对象**的证书。**数字证书里面包含了服务器的对外的公钥**

##### SSL（安全套接层）

* 提供数据安全和数据完整性服务。
* 对传输层数据进行加密后传输



https://github.com/Snailclimb/JavaGuide/blob/master/docs/network/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93.md