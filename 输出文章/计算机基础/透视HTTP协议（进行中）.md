## 透视HTTP协议

### HTTP是什么？

HTTP协议是     **超文本**      **传输**      **协议**

* ##### **协议**

HTTP是用在计算机世界里的协议。它使用计算机能够理解的语言确立了一种计算机之间交流通信的规范，以及相关的各种控制和错误处理方式。

* ##### **传输**

HTTP是一个在计算机世界里专门用来在两点之间传输数据的协定和规范。

* ##### **超文本**

超文本就是超越了普通的文本的文本，它包含了文字、图片、音频和视频等的混合体。

**所以HTTP就是一个在计算机世界里专门在两点之间传输文字、图片、音频和视频等超文本数据的约定和协议。**

HTTP协议是跑在TCP/IP协议栈之上的，依靠IP协议实现寻址和路由、TCP协议实现可靠地数据传输、DNS协议实现域名查找解析、SSL/TLS协议实现安全的通信机制。

### HTTP相关协议

#### TCP/IP

帮助实现寻址、路由、可靠传输等。

#### DNS

使用IP地址来标识计算机。然后通过有意义的名字作为ip地址的等价替代。从而实现寻址。

#### URI/URL

DNS和IP地址只是标记了互联网上的主机，但是主机上有文本、图片、页面等等。需要使用URI（统一资源标识符）来唯一的标记互联网上的资源。

URL（统一资源定位符），也就是网址。它是URI的一个自己。

#### HTTPS

https其实相当于SSL+HTTP。也就是运行在SSL/TLS协议上的HTTP。这里的HTTP不再是之前所说的的TCP/IP之上的协议了。而是说HTTP运行在SSL协议之上，而SSL协议运行在TCP/IP协议之上。

所以**HTTPS=HTTP+SSL/TSL+TCP/IP**。

代理是 HTTP 传输过程中的“中转站”，可以实现缓存加速、负载均衡等功能。

### HTTP

#### 报文

HTTP的协议基本流程是“请求-应答”“一发一收”的模式，工作模式非常简单，主要是因为TCP/IP协议负责底层的具体传输工作。

HTTP协议报文规定了组成部分，解析规则，处理策略等。可以在TCP/IP层上实现更灵活丰富的功能，例如连接控制、缓存管理、数据编码、内容协商等等。

HTTP协议的请求报文和响应报文由三部分组成

* 起始行：描述请求或响应的基本信息
* 头部字段集合：使用key-value形式更详细的说明报文
* 消息正文：事假传输的数字。

前两部分又成为“**请求头、响应头**”，消息正文又称为**实体（body）**

####  URI

URI：统一资源定位符。用来唯一的表示资源的位置或者名称。

格式：scheme://           host:port    path    ?query

* scheme：协议名称，例如http、ftp、file等
* host:port：主机名+端口号。如果端口号没有的话，浏览器会默认根据scheme使用默认的端口号。
* path：资源所在位置。必须以 /  开始。

##### URI编码

URI只能使用ASCII码。如果使用其他语言的话，会进行对应的转义。

URI转义简单粗暴：直接把非ASCII码或特殊字符转换为16进制字节值，然后前面加上 一个 %。

#### 状态码

这里说的是**状态码**，而不是**错误码**。也就是说它的含义不仅是错误，更重要的在于表达返回的数据处理的状态。客户端可以根据状态适时的进行处理。比如说继续请求、切换协议、重定向等等。

种类：

1XX：提示信息，表示目前是协议处理的中间状态。

2XX：成功，报文接收并被处理

3XX：重定向，资源位值变动，需要重新发送请求

4XX：客户端错误，请求报文有误，服务器无法处理

5XX：服务器错误，服务器在处理请求的时候发生了错误

#### 特点

**扩展灵活**：能够灵活扩展，通过消息头和消息体，可以进行任何形式的处理。

**可靠传输**：基于TCP的可靠传输协议

**应用层协议**：HTTP凭借着可携带任意头字段和实体数据的报文结构，以及连接控制、缓存代理等方便易用的特性，成为应用层的“明星”协议

**应答：**HTTP协议使用的是**请求-应答通信模式**

**无状态**：HTTP协议是无状态的。不会在服务器里保存一些数据或者标志，记录通信过程中的变化信息。

#### 优缺点

明文传输：协议的报文不实用二进制数据，而是简单可阅读的文本形式。可以通过抓包就可以查看和修改。调试方便。但是可能会被黑客抓包。

不安全：在身份认证和完整性校验方面比较欠缺。这种如果数据被篡改，那么http是无法获知数据是真的还是被修改之后的数据。

性能：“不算差，不够好”。HTTP采用“请求-应答”的模式，可能会导致著名的“队头阻塞”问题：当顺序发送的请求序列中的一个请求因为某种原因被阻塞时，在后面排队的所有请求也一并被阻塞，会导致客户端迟迟收不到数据。

### HTTP数据实体

#### 数据类型和编码

HTTP通过**MIME type**来标记对应的数据类别。然后通过**Encoding type**来定义对应的压缩格式（gzip、deflate、br等）。

##### 数据类型头字段

HTTP通过**MIME type**来标记对应的数据类型。定义了Accept请求头字端和两个Content实体头字段。客户端通过**Accept**头告诉服务器希望接收的数据格式类型。而服务器通过Content头告诉客户端实际发送的数据格式。

```http
Accept: text/html,application/xml,image/webp,image/png
```

accept可以提供多个类型，让服务器有更多的选择余地。

服务器的**Content-Type**头字段能够告诉具体的数据类型。

```http
Content-Type: text/html
Content-Type: image/png
```

**Accept-Encoding**字段标记的是客户端支持的压缩格式，也可以用，来列出多个。同事服务器也可以返回具体的压缩格式。

```http
Accept-Encoding: gzip, deflate, br
Content-Encoding: gzip
```

#### 语言类型和编码

HTTP引入了：语言类型和字符集概念。

**语言类型是人类使用的自然语言**。“type-subtype”形式也可以区分不同区域。举几个例子：en 表示任意的英语，en-US 表示美式英语，en-GB 表示英式英语，而 zh-CN 就表示我们最常使用的汉语。

**字符集是计算机处理的语言**。比如说ASCII、GBK、UTF-8、Unicode等等。

##### 语言类型字段头

Accept-Language字段标记了客户端可理解的自然语言，也允许用“,”做分隔符列出多个类型

```http
Accept-Language: zh-CN, zh, en
```

上面的意思是：最好给我zh-CN的汉语文字，如果没有就用其他汉语方言，如果还没有就给英文。

Content-Language**告诉客户端实体数据使用的实际语言类型

```http
Content-Language: zh-CN
```

字符集在 HTTP 里使用的请求头字段是**Accept-Charset**。而在相应头，没有对应的Content-Charset。而是在**Content-Type**字段的类型后面用“charset==xxx”来表示。

**对于post请求，不能使用Accept-\*来处理。因为post相当于是发送数据给服务器，需要像服务器使用Content-\*一样。来提交对应的数据**

#### 数据压缩

* GZIP压缩（文本压缩）
* 分块传输（用于大文件下载等）
* 范围请求（用于播放视频，然后拖动直接跳转到某个位置开始播放）。需要使用“Content-Range”
* 多段数据：需要使用“**multipart/byteranges**”这个MIME类型

#### 连接

##### 短连接

HTTP之前的0.9、1.0协议是采用最简单的‘请求-应答’方式。建立连接-传输通信-关闭连接。所以称之为**短连接**。

然而，TCP/IP的三次握手，四次挥手。如果每次进行http的通讯，都进行这种握手挥手的操作，那么相当于。三次握手，说句话，四次挥手。**造成了很大的资源浪费**。

##### 长连接

针对短连接的问题，HTTP提出了**长连接**。即：持久连接，保活连接，连接复用。

![image-20200828222335729](http://cdn.qiniu.kailaisii.com/typora/20200828222336-546672.png)

在HTTP1.1中默认开始长连接。不需要特殊头字段指定。也可以在请求头里面使用“Connection: keep-alive”来进行设置。

如果长连接一直占用连接而不发送数据的话，会导致资源浪费，所以这里需要根据需要手动关闭长连接。可以使用**COnnection:close** 来关闭。

##### 队头阻塞

##### 性能优化

只要使用“请求-应答”模式，那么队头阻塞就会存在。可以使用“**并发连接**”来进行处理

##### 域名分片

使用多个域名，域名都指向同一个服务器，就可以解决一台机器只能有两三个长连接的问题。

#### Cookie

#### 缓存