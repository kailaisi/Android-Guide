## 代码重构法则

译文：https://sourcemaking.com/refactoring/smells/long-method

不想写好代码的码农不是好士兵。平时开发用惯了CV大法，在后来的维护过程中发现维护越来越难，慢慢对开发中经常遇到的代码问题提出对应的解决方案。陪我一起走上重构之旅吧，当你回头再遇到相同问题时候，相信会给你新的灵感~

### Swtch分支

**特征**

有一系列的**switch**或者**if**分支操作。

**问题的原因**

尽量减少*switch*和*case*是面向对象编程的标志之一。通常情况下，对于单个的*switch*出现在不同的地方是可以接受的。但是如果增加了新的功能，需要找到原来的*switch*，然后进行修改。

当你遇到这种情况的话，就可以考虑多态。

**解决方案**

* 隔离*switch*，将其放到正确的类中。可能需要**提取法**然后**移动法**。
* 如果*switch*是基于类型的。例如不同的运行模式进行切换。那么使用**用子类替换类型法**和**用策略代替类型法**
* 指定继承关系之后，通过**多态取代条件法**来进行使用。
* 如果没有特别多的分支，而且会调用相同的参数（只是参数不同），这时候没必要使用多态。这种情况下可以将分支内的代码分解为较小的方法。用**显示方法替换成参数法**来取代相关参数。
* 如果有一个分支是*null*，则运用**使用NULL对象法**

##### 忽略优化

* *switch*分支执行简单操作，没有必要做更改。
* *switch*用在工厂设计模式来选择使用哪个类的情况下，不需要优化。

### 重构技巧

#### 提取法

```java
void printOwing() {
  printBanner();
  // Print details.
  System.out.println("name: " + name);
  System.out.println("amount: " + getOutstanding());
}
```

问题：有一段打印的代码可以区分开

```java
void printOwing() {
  printBanner();
  printDetails(getOutstanding());
}

void printDetails(double outstanding) {
  System.out.println("name: " + name);
  System.out.println("amount: " + outstanding);
}
```

解决方案：将这部分代码移到单独的方法中，然后原方法进行调用。

##### 重构原因

一段代码中的行数越多，越难以理解方法的作用。除了简单的移除代码中的肮脏的代码，提取法也是其他重构方法的重要步骤。

##### 好处

* 更易读的代码。确保要给方法取一个描述性的名称 *createOrder()*，*renderCustomerInfo()*等。
* 减少重复的代码。通常情况下，如果一段代码在其他地方有重用的。可以使用调用新方法来来替换。
* 代码片段具有独立性，发生错误的概率更小。

##### 重构方法

1. 创建一个新的方法，取一个具有描述性的名称。
2. 如果提取的代码参数发生了变化，要注意是否会影响主方法。

#### 移动法

问题：一个在A类中的方法，在B类中调用的次数比在A类中调用的次数还多。

解决方案：将方法移到B类中，然后A类通过调用来新的方法。

##### 重构原因

1. 将方法移动到使用该方法最多的类中，这会使得**类的内部一致性**更强。
2. 移动方法以后如果能够减少或者消除对原来的类的依赖关系。那么这种方案能够有效的实现**减少类之间的依赖**

##### 如何重构

要自习分析方法所涉及到的类的特性。如果这个方法只在特定的特性下使用，那么这个特性也应该移动到新类中。如果这个特性可能在其他方法中也有使用，那么这些方法都应该跟着移动到新类中。

1. 要确保方法没有在超类和子类中的声明。否则的话，就应该避免进行移动。也可以通过多态性来保证方法在不同类中的不同功能。
2. 在目标类B中创建一个新的方法。你也许可能想在新的类中创建一个新的方法。
3. 要决定如何在A类中引用目标类B。必须保证已经有返回对象的方法或者字段，没有的话，需要去创建一个新的方法或者字段来保存对象B的信息。
4. 将旧方法转换为对新方法的引用。

#### 用子类替换类型代码

> 类型代码：有一组数字或者字符串，组成了实体的允许值列表时，类型代码就产生了。通常情况下，这些数字或者字符串都被赋予可以理解的名称。

![image-20200611160249605](http://cdn.qiniu.kailaisii.com/typora/202006/11/160250-433138.png)

问题：有一个type的编码类型（这个字段的值可能触发条件的不同代码）

![image-20200611160321893](http://cdn.qiniu.kailaisii.com/typora/202006/11/160322-22951.png)

解决方法：对type对应的值创建对应子类，将相关的行为从原始类提取到子类中。将控制流替换为多态。

##### 重构原因

对于这种类型代码，虽然我们赋予了很容易理解的名称，但是使用的时候仍然会容易出错。例如一个方法接收这些值之一作为一个参数。调用方法的人很可能不会使用*USER_TYPE_ADMIN*这个静态变量来表示*ADMIN*，而是自己输入了小写的*admin*，这种情况就可能会导致程序完全没有按照我们所需要的条件去执行。

##### 好处

* 可以删除分支控制的代码。将代码移动到合适的子类中， 而不是通过笨重的*switch*在原始类中实现。这符合*单一职责原则*。
* 当需要添加新值的时候，只需要添加子类即可，不需要修改现有代码。符合*开放/封闭原则*。

##### 不适合的场景

* 已经有了父类，不能再继承另一个父类了。这种情况下可以通过组合来替换类型代码。

##### 如何重构

1. 为类型代码创建对应的get方法。
2. 

## ////todo

每次调用方法之前，都必须调用未来参数对象的方法。如果这些方法或为该方法获得的数据的数量发生了变化，您将需要在程序中仔细地找到十几个这样的位置，并在每个位置中实现这些更改。

应用这种重构技术后，获取所有必要数据的代码将存储在一个地方--方法本身。

##### 好处

- 看到的不是大量的参数，而是具有可理解名称的单个对象。
- 如果该方法需要来自对象的更多数据，则无需重写使用该方法的所有位置--仅在方法本身内修改即可。

##### 弊端

有时，这种转换会导致方法变得不那么灵活：以前，该方法可以从许多不同的源获取数据，但是现在，由于重构，我们将它的使用限制在具有特定接口的对象上。

##### 重构方法

1. 在方法中为对象创建一个参数，从中获取必要的值。
2. 现在开始逐个从方法中删除旧参数，代之以调用参数对象的相关方法。每次更换参数后测试程序。
3. 从方法调用之前的参数对象中删除getter代码。

#### 用方法对象替换方法

```java
class Order {
  // ...
  public double price() {
    double primaryBasePrice;
    double secondaryBasePrice;
    double tertiaryBasePrice;
    // Perform long computation.
  }
}
```

问题：方法很长，而且局部变量交织，不能使用**提取法**

```java
class Order {
  // ...
  public double price() {
    return new PriceCalculator(this).compute();
  }
}

class PriceCalculator {
  private double primaryBasePrice;
  private double secondaryBasePrice;
  private double tertiaryBasePrice;
  
  public PriceCalculator(Order order) {
    // Copy relevant information from the
    // order object.
  }
  
  public double compute() {
    // Perform long computation.
  }
}
```

解决方法：将方法转化为单独的类，局部变量变为类的字段。然后将方法拆分为同一个类中的多个方法。

##### 重构原因

方法太长，而且因为存在大量的局部变量而无法将其抽取为小的方法。

将方法隔离为单独的类，将局部变量转变为类的字段。

通过类级别的隔离，将大型和笨重的方法分解为较小的方法铺平了道路。

##### 好处

可以防止长方法的继续膨胀。而且允许将其拆分为类中的字方法，而不会使程序污染原来的类。

##### 弊端

增加了一个类，增加了程序的复杂性。

##### 重构方法

1. 创建一个新类。根据重构方法的目的命名它。
2. 在新类中，创建一个私有字段，用于存储对方法之前所在的类的实例的引用。如果需要，可以使用它从原始类获取一些必需的数据。
3. 为方法的每个局部变量创建单独的私有字段。
4. 创建一个构造函数，该构造函数接受方法的所有局部变量的值作为参数，并初始化相应的私有字段。
5. 声明主方法并将原始方法的代码复制到它，用私有字段替换局部变量。
6. 通过创建方法对象并调用其主方法来替换原始类中原始方法的主体。

#### 引入参数对象法

![img](http://cdn.qiniu.kailaisii.com/typora/202006/01/174547-809764.png)

问题：方法中包含了重复的参数

![img](http://cdn.qiniu.kailaisii.com/typora/202006/01/174603-201974.png)

解决方法：用对象代替参数

##### 重构原因

在多个方法中经常会遇到相同的一组参数。这会导致参数本身和相关操作的代码重复。通过在单个类中合并参数，还可以将处理此数据的方法移到那里，从而将其他方法从此代码中解放出来。

##### 好处

* 更易读的代码。看到的不再是大量的参数，而是具有可理解名称的单个对象
* 分散在各处的相同的参数组创建了它们自己的代码复制类型：虽然没有调用相同的代码，但经常会遇到相同的参数和参数组

##### 弊端

- 如果您只将数据移动到一个新的类中，并且不打算将任何行为或相关操作移到新类中，这个类看起来像[数据类]

##### 重构方法

1. 创建一个表示参数组的新类。使类不可变。
2. 在要重构的方法中，使用[添加参数法](https://sourcemaking.com/refactoring/add-parameter)，传递参数对象。在所有方法调用中，将从旧方法使用参数创建的对象传递给此参数。
3. 逐个从方法中删除旧参数，用参数对象的字段替换代码中的旧参数。在每个参数替换后测试程序。
4. 完成后，查看是否有必要将方法的一部分(有时甚至整个方法)移动到参数对象类。如果是，请使用[移动法](https://sourcemaking.com/refactoring/move-method)或[提取法](https://sourcemaking.com/refactoring/extract-method).

### 总结

长方法应该属于代码中最常见也是最好处理的一种优化点了，在以后的开发中多注意一些，你会发现你的代码会优雅很多，而且可维护性也会高很多。