## 电量优化你不得不知道的秘密

什么？我写个“破”应用还得管电量？我哪儿知道自己写的应用费不费电啊。。。因为每次谈起“电量优化”这个词，总有一种神秘感，不知从何入手。

但是当我们自己使用手机的时候：这个破应用怎么那么费电？长按，上滑，走起~~~

如果你的应用已经达到了微信这种体量级，用户不得不用的，那你可以翻篇了。

### 基础知识

#### 概述

其实对于一个移动设备来说，有两个耗电大户：CPU和显示屏。为了降低这两个元件的耗电量，在Android系统中，也会通过电源管理来实现降低电量消耗的功能。

对于CPU，大多都会设计两种工作频率，大部分时间内CPU都工作在**降低频率**下，只有**进行密集计算**时，才会切换到高频率。这也就是为什么我们看视频，看直播，玩游戏，上网的时候，会明显感觉手机玩不了多久就得充电的原因。

对于显示屏。系统则会尽量减少亮屏的时间，当用户长时间不操作的时候，就会息屏等等。

#### 电源管理架构

Android系统有一套自己的架构来来实现来实现对于电源的管理。其主要分为四个层次：

**应用接口层**：PowerManger开放给应用一系列的接口，应用可以通过PM的接口来申请wakelock，唤醒系统，使系统进入睡眠等操作。

**Framework层**：应用调用PowerManager开放的接口，来对系统进行一些列的操作是在PowerManagerService中完成的。PMS中处理和电量相关的计算。属于电源管理的决策层。协调与其他模块的交互，比如亮屏、暗屏、系统休眠、唤醒等等。

**HAL层**：power.c文件，通过上层传递下来的参数，向/sys/power/wake_lock或者/sys/power/wake_unlock文件节点写数据与Kernel层进行通信。

**Kernel层**：控制对应的硬件。不管是屏幕还是cpu，统属于硬件，最终通过对硬件的控制来实现对电量管理。

整个架构如下：

![image-20200623135836580](C:\Users\wu\AppData\Roaming\Typora\typora-user-images\image-20200623135836580.png)

**重要的接口**

在电源管理系统中，介绍几个比较的接口。

* userActivity()：报告影响系统休眠的用户活动，重新计算灭屏时间。假设我们手机设置15秒不操作，就息屏。那么我们每次触屏或者滑屏的时候，都会调用这个方法，然后系统会重新进行倒计时的操作。
* Wakelock：提供了相关的接口来操作wakelock锁。比如说申请或者释放等。

#### WakeLock机制

wakelock是一种锁机制，只要有应用拿着这个锁，那么CPU就无法进入休眠，会一直处于工作的状态。

一般手机待机时，LCD、WIFI都会进入休眠状态，Android应用程序的代码也会停止运行。

为了**保证程序中关键代码的正确执行，提供了Wake Lock的API**，使得应用程序能够通过代码阻止CPU进入休眠状态。而这种情况的滥用，则会成为电量杀手。

### 工具

叨叨那么多，那么我怎么知道我的应用耗电多少啊？其实还是有一些功能能够辅助我们来查询电量的使用情况的。

#### Battery Historian

##### 介绍

Google提供的一套专门分析电量使用的工具。能够**支持Android5.0及以后**的设备商进行电池的相关信息和事件分析。它是一款可视化功能，对于**系统级别和应用级别**的事件都能够**清晰直观**的展现出应用的**耗电比例、执行时间、次数**等等。而且 还支持**两个bugreport文件的对比**，对关键的区别点高亮显示。

##### 使用方式

##### 结果分析

**特点**

可视化分析工具，

### 电量优化方案